{% extends "base.html" %}

{% block title %}Admin Dashboard - PvPocket{% endblock %}

{% block extra_css %}
<style>
    .admin-layout {
        display: flex;
        min-height: calc(100vh - 56px); /* Account for navbar height */
        margin: 0;
        padding-top: 0;
        position: relative;
        z-index: 1; /* Ensure admin layout doesn't interfere with navbar */
    }
    
    .admin-sidebar {
        width: 200px;
        min-width: 200px;
        background: var(--card-bg);
        border-right: 2px solid var(--border-color);
        padding: 0;
        overflow-y: auto;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        height: 100vh;
        z-index: 10; /* Below navbar but above content */
    }
    
    .admin-main {
        flex: 1;
        padding: 2rem;
        background: var(--bg-color);
        min-height: calc(100vh - 56px);
        overflow-x: auto;
    }
    
    .sidebar-header {
        padding: 1.25rem 1rem;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), rgba(25, 135, 84, 0.08));
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .sidebar-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    
    .sidebar-nav {
        padding: 1rem 0;
    }
    
    .admin-sidebar .nav-section {
        margin-bottom: 1.5rem;
    }
    
    .admin-sidebar .nav-section:last-child {
        margin-bottom: 0;
    }
    
    .admin-sidebar .nav-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #6c757d;
        margin: 1rem 1.5rem 0.75rem;
        letter-spacing: 0.5px;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid rgba(108, 117, 125, 0.2);
    }
    
    .admin-sidebar .nav-section:first-child .nav-section-title {
        margin-top: 0;
    }
    
    .admin-sidebar .nav-item {
        display: block;
        padding: 0.75rem 1rem;
        color: var(--text-color);
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
        border-radius: 0 0.5rem 0.5rem 0;
        margin: 0.25rem 0 0.25rem 0.5rem;
        font-size: 0.9rem;
    }
    
    .admin-sidebar .nav-item:hover {
        background: rgba(13, 110, 253, 0.1);
        border-left-color: #0d6efd;
        color: var(--text-color);
        text-decoration: none;
        transform: translateX(2px);
    }
    
    .admin-sidebar .nav-item.active {
        background: rgba(13, 110, 253, 0.15);
        border-left-color: #0d6efd;
        color: #0d6efd;
        font-weight: 600;
        transform: translateX(4px);
    }
    
    /* Icon styles removed - clean text navigation */
    
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }
    
    .content-title {
        font-size: 2rem;
        font-weight: bold;
        color: var(--text-color);
        margin: 0;
    }
    
    .alert-bar {
        position: relative;
        z-index: 1;
        margin: -2rem -2rem 2rem -2rem;
        border-radius: 0;
        border-left: none;
        border-right: none;
        border-top: none;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 0.75rem;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }
    
    .stat-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stat-icon {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
        opacity: 0.8;
    }
    
    .stat-number {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--text-color);
        margin-bottom: 0.15rem;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .status-healthy { background: #28a745; }
    .status-warning { background: #ffc107; }
    .status-error { background: #dc3545; }
    .admin-tabs {
        display: flex;
        flex-wrap: wrap;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 2rem;
        gap: 0.25rem;
    }
    
    .admin-tab {
        padding: 0.65rem 1rem;
        background: none;
        border: none;
        color: #6c757d;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        border-bottom: 3px solid transparent;
        flex-shrink: 0;
    }
    
    .admin-tab:hover {
        color: var(--text-color);
        background: rgba(13, 110, 253, 0.05);
    }
    
    .admin-tab.active {
        color: #0d6efd;
        border-bottom-color: #0d6efd;
        font-weight: 600;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .action-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .action-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .action-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    
    .action-card-header-left {
        display: flex;
        align-items: center;
    }
    
    .action-card-icon {
        font-size: 1.5rem;
        margin-right: 0.75rem;
        opacity: 0.8;
    }
    
    .action-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }
    
    .action-card-description {
        color: #6c757d;
        font-size: 0.875rem;
        margin-bottom: 1rem;
        line-height: 1.4;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .info-panel {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .panel-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
    }
    
    .panel-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 0.875rem;
    }
    
    .activity-content {
        flex: 1;
    }
    
    .activity-text {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-color);
    }
    
    .activity-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin: 0;
    }
    .btn-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        border-radius: 0.375rem;
    }
    
    .btn-outline {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
    }
    
    .btn-outline:hover {
        background: var(--border-color);
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    
    .data-table th {
        background: rgba(0,0,0,0.02);
        font-weight: 600;
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .mobile-hide {
        display: none;
    }
    
    @media (min-width: 768px) {
        .mobile-hide {
            display: table-cell;
        }
    }
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }
    
    .modal-dialog {
        position: relative;
        margin: 2rem auto;
        max-width: 800px;
    }
    
    .modal-content {
        background: var(--card-bg);
        border-radius: 0.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
    }
    
    .modal-body {
        padding: 1.5rem;
        color: var(--text-color);
    }
    
    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6c757d;
        cursor: pointer;
    }
    
    .input-group {
        display: flex;
        align-items: stretch;
    }
    
    .input-group .form-control {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-right: none;
        border-radius: 0.375rem 0 0 0.375rem;
        font-size: 0.875rem;
    }
    
    .input-group-append .btn {
        border-radius: 0 0.375rem 0.375rem 0;
    }
    
    .badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 0.25rem;
    }
    
    .badge-success {
        background: #d4edda;
        color: #155724;
    }
    
    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }
    
    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }
    
    .user-details p {
        margin-bottom: 0.5rem;
    }
    
    .user-details code {
        background: rgba(0, 0, 0, 0.1);
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }
    
    .config-section {
        margin-bottom: 2rem;
    }
    
    .config-section h5 {
        margin-bottom: 1rem;
        color: var(--text-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
    }
    
    @media (max-width: 1024px) {
        .admin-sidebar {
            width: 180px;
            min-width: 180px;
        }
        
        .admin-sidebar .nav-item {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
        
        .sidebar-header {
            padding: 1rem;
        }
        
        .admin-sidebar .nav-section-title {
            margin: 0.75rem 1rem 0.5rem;
            font-size: 0.7rem;
        }
    }
    
    @media (max-width: 768px) {
        .admin-layout {
            flex-direction: column;
        }
        
        .admin-sidebar {
            width: 100%;
            min-width: unset;
            position: relative;
            height: auto;
            box-shadow: none;
            border-right: none;
            border-bottom: 2px solid var(--border-color);
            z-index: 10;
        }
        
        .sidebar-nav {
            padding: 0.5rem 0;
        }
        
        .admin-sidebar .nav-item {
            margin: 0.125rem 0.25rem;
            padding: 0.75rem 1rem;
        }
        
        .admin-main {
            padding: 1rem;
            min-height: auto;
        }
        
        .alert-bar {
            margin: -1rem -1rem 1rem -1rem;
            font-size: 0.875rem;
        }
        
        
        .action-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .data-table {
            font-size: 0.875rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .content-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }
    
    /* Color-coded stat cards */
    .stat-card.system { border-left: 4px solid #6c757d; }
    .stat-card.system .stat-icon { color: #6c757d; }
    
    .stat-card.database { border-left: 4px solid #0d6efd; }
    .stat-card.database .stat-icon { color: #0d6efd; }
    
    .stat-card.performance { border-left: 4px solid #198754; }
    .stat-card.performance .stat-icon { color: #198754; }
    
    .stat-card.firestore { border-left: 4px solid #ff6b6b; }
    .stat-card.firestore .stat-icon { color: #ff6b6b; }
    
    /* Support Tickets Styles */
    .support-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .support-stats .stat-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
    }
    
    .stat-card.cards { border-left: 4px solid #6f42c1; }
    .stat-card.cards .stat-icon { color: #6f42c1; }
    
    .stat-card.users { border-left: 4px solid #20c997; }
    .stat-card.users .stat-icon { color: #20c997; }
    
    /* Support Tickets Styles */
    .support-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .support-stats .stat-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .stat-info {
        flex: 1;
    }
    
    .stat-total { border-left: 4px solid #6c757d; }
    .stat-new { border-left: 4px solid #dc3545; background: rgba(220, 53, 69, 0.05); }
    .stat-resolved { border-left: 4px solid #198754; background: rgba(25, 135, 84, 0.05); }
    
    .stat-new .stat-icon { color: #dc3545; }
    .stat-resolved .stat-icon { color: #198754; }
    
    .ticket-controls {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .ticket-tabs {
        display: flex;
        gap: 0.5rem;
    }
    
    .ticket-tab {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        background: transparent;
        color: var(--text-color);
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .ticket-tab:hover {
        background: var(--hover-bg);
        border-color: #0d6efd;
    }
    
    .ticket-tab.active {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    .tab-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.125rem 0.375rem;
        border-radius: 0.75rem;
        font-size: 0.75rem;
        min-width: 1.25rem;
        text-align: center;
    }
    
    .ticket-search {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }
    
    .search-box {
        position: relative;
        min-width: 250px;
    }
    
    .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        z-index: 2;
    }
    
    .search-box input {
        width: 100%;
        padding: 0.5rem 0.75rem 0.5rem 2.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background: var(--input-bg);
        color: var(--text-color);
        font-size: 0.9rem;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .clear-search {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.25rem;
        transition: all 0.3s ease;
    }
    
    .clear-search:hover {
        background: var(--hover-bg);
        color: var(--text-color);
    }
    
    .sort-select {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background: var(--input-bg);
        color: var(--text-color);
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .tickets-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .tickets-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }
    
    /* Optimized column widths - better spacing */
    .tickets-table th:nth-child(1), .tickets-table td:nth-child(1) { width: 8%; } /* ID */
    .tickets-table th:nth-child(2), .tickets-table td:nth-child(2) { width: 30%; } /* Subject */
    .tickets-table th:nth-child(3), .tickets-table td:nth-child(3) { width: 22%; } /* Email */
    .tickets-table th:nth-child(4), .tickets-table td:nth-child(4) { width: 18%; } /* Date */
    .tickets-table th:nth-child(5), .tickets-table td:nth-child(5) { width: 12%; } /* Status */
    .tickets-table th:nth-child(6), .tickets-table td:nth-child(6) { width: 10%; } /* Actions */
    
    .tickets-table th,
    .tickets-table td {
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid var(--border-color);
        text-align: left;
        vertical-align: middle;
        word-wrap: break-word;
        overflow: hidden;
    }
    
    /* Specific alignment for different columns */
    .tickets-table th:nth-child(4), .tickets-table td:nth-child(4) { text-align: center; } /* Date */
    .tickets-table th:nth-child(5), .tickets-table td:nth-child(5) { text-align: center; } /* Status */
    .tickets-table th:nth-child(6), .tickets-table td:nth-child(6) { text-align: center; } /* Actions */
    
    .tickets-table th {
        background: var(--table-header-bg);
        font-weight: 600;
        color: var(--text-color);
        border-bottom: 2px solid var(--border-color);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .tickets-table tbody tr {
        transition: all 0.3s ease;
    }
    
    .tickets-table tbody tr:hover {
        background: var(--hover-bg);
    }
    
    .ticket-id {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .ticket-title {
        font-weight: 600;
        color: var(--text-color);
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .ticket-email {
        font-size: 0.875rem;
        color: #0d6efd;
        cursor: pointer;
        text-decoration: underline;
        text-decoration-style: dotted;
    }
    
    .ticket-email:hover {
        text-decoration-style: solid;
    }
    
    .ticket-date {
        font-size: 0.875rem;
        color: #6c757d;
        white-space: nowrap;
    }
    
    /* Simple tooltip functionality */
    .ticket-title {
        cursor: help;
        position: relative;
    }
    
    /* Tooltip container - will be positioned via JavaScript */
    .custom-tooltip {
        position: fixed;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.875rem;
        line-height: 1.4;
        max-width: 300px;
        white-space: normal;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        pointer-events: none;
        display: none;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }
    
    .status-badge.new {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    .status-badge.in_progress {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .status-badge.resolved {
        background: rgba(25, 135, 84, 0.1);
        color: #198754;
        border: 1px solid rgba(25, 135, 84, 0.2);
    }
    
    .status-badge.closed {
        background: rgba(108, 117, 125, 0.1);
        color: #6c757d;
        border: 1px solid rgba(108, 117, 125, 0.2);
    }
    
    .ticket-actions {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 0.25rem 0.25rem;
        height: 100%;
        gap: 0.2rem;
        min-height: 60px;
    }
    
    .ticket-actions .btn {
        font-size: 0.7rem;
        padding: 0.35rem 0.6rem;
        border-radius: 0.25rem;
        border: 1px solid transparent;
        cursor: pointer;
        min-width: 65px;
        max-width: 85px;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        text-decoration: none;
    }
    
    .btn-reply {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    .btn-reply:hover {
        background: #0b5ed7;
        border-color: #0a58ca;
    }
    
    .btn-status {
        background: var(--card-bg);
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .btn-status:hover {
        background: var(--hover-bg);
        border-color: #0d6efd;
    }
    
    .loading-state, .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6c757d;
        font-size: 1rem;
    }
    
    .empty-state i {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* Ticket Content Expansion Styles */
    .ticket-subject-container {
        position: relative;
    }
    
    .ticket-subject {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }
    
    .ticket-preview {
        font-size: 0.85rem;
        color: #6c757d;
        line-height: 1.3;
        margin-bottom: 0.25rem;
    }
    
    .btn-expand {
        background: none;
        border: none;
        color: #0d6efd;
        font-size: 0.75rem;
        cursor: pointer;
        padding: 0.15rem 0;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        transition: color 0.2s ease;
    }
    
    .btn-expand:hover {
        color: #0b5ed7;
        text-decoration: underline;
    }
    
    .ticket-content-row {
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
    }
    
    .ticket-content-detail {
        padding: 1rem;
        background: rgba(13, 110, 253, 0.05);
        border-radius: 0.375rem;
        margin: 0.5rem;
    }
    
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        color: var(--text-color);
    }
    
    .btn-close-content {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
    }
    
    .btn-close-content:hover {
        background: rgba(0, 0, 0, 0.1);
        color: var(--text-color);
    }
    
    .content-message {
        background: var(--bg-color);
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid var(--border-color);
        font-size: 0.9rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: var(--text-color);
    }
    
    /* Reply Modal Styles */
    .reply-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .reply-modal.show {
        opacity: 1;
        visibility: visible;
    }
    
    .reply-modal-content {
        background: var(--card-bg);
        border-radius: 0.5rem;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }
    
    .reply-modal.show .reply-modal-content {
        transform: translateY(0);
    }
    
    .reply-modal-header {
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .reply-modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .reply-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
        padding: 0.25rem;
        border-radius: 0.25rem;
        transition: all 0.3s ease;
    }
    
    .reply-modal-close:hover {
        background: var(--hover-bg);
        color: var(--text-color);
    }
    
    .reply-modal-body {
        padding: 1.25rem;
        max-height: 60vh;
        overflow-y: auto;
    }
    
    .original-ticket {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1.25rem;
    }
    
    .original-ticket-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .original-ticket-content {
        color: var(--text-color);
        line-height: 1.6;
    }
    
    .reply-form .form-group {
        margin-bottom: 1rem;
    }
    
    .reply-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-color);
    }
    
    .reply-form textarea {
        width: 100%;
        min-height: 120px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background: var(--input-bg);
        color: var(--text-color);
        font-family: inherit;
        resize: vertical;
    }
    
    .reply-form textarea:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .reply-modal-footer {
        padding: 1.25rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
        .support-stats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .ticket-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .ticket-search {
            justify-content: space-between;
        }
    }
    
    @media (max-width: 768px) {
        .support-stats {
            grid-template-columns: 1fr;
        }
        
        .ticket-tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            width: 100%;
        }
        
        .search-box {
            min-width: 200px;
            flex: 1;
        }
        
        .tickets-table th:nth-child(4),
        .tickets-table td:nth-child(4) {
            display: none;
        }
        
        .ticket-actions {
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .ticket-actions .btn {
            min-width: 60px;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
        
        .reply-modal-content {
            width: 95%;
            margin: 1rem;
        }
        
        .ticket-content-detail {
            margin: 0.25rem;
            padding: 0.75rem;
        }
        
        .content-message {
            padding: 0.5rem;
            font-size: 0.85rem;
        }
        
        .btn-expand {
            font-size: 0.7rem;
        }
    }
    
    /* Dark mode adjustments */
    [data-theme="dark"] .admin-header {
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.2), rgba(25, 135, 84, 0.2));
    }
    
    [data-theme="dark"] .quick-action-btn:hover {
        background: #0d6efd;
        color: white;
    }
    
    [data-theme="dark"] .ticket-controls {
        background: #1a1d23;
        border-color: #2d3748;
    }
    
    [data-theme="dark"] .tickets-container {
        background: #1a1d23;
        border-color: #2d3748;
    }
    
    [data-theme="dark"] .tickets-table th {
        background: #2d3748;
        color: #e2e8f0;
    }
    
    [data-theme="dark"] .tickets-table tbody tr:hover {
        background: #2d3748;
    }
    
    [data-theme="dark"] .search-box input,
    [data-theme="dark"] .sort-select {
        background: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
    }
    
    [data-theme="dark"] .original-ticket {
        background: #2d3748;
        border-color: #4a5568;
    }
    
    [data-theme="dark"] .reply-modal-content {
        background: #1a1d23;
    }
    
    [data-theme="dark"] .reply-form textarea {
        background: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
    }
    
    /* Dark mode tooltip styling */
    [data-theme="dark"] .custom-tooltip {
        background: rgba(255, 255, 255, 0.95);
        color: #1a1d23;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-layout">
    <!-- Sidebar Navigation -->
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <h1 class="sidebar-title">Admin Panel</h1>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <a href="#" class="nav-item" data-tab="overview" onclick="switchTab('overview', event)">
                    Dashboard
                </a>
                <a href="#" class="nav-item" data-tab="analytics" onclick="switchTab('analytics', event)">
                    Analytics
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <a href="#" class="nav-item" data-tab="users" onclick="switchTab('users', event)">
                    User Management
                </a>
                <a href="#" class="nav-item" data-tab="content" onclick="switchTab('content', event)">
                    Content Moderation
                </a>
                <a href="#" class="nav-item" data-tab="tickets" onclick="switchTab('tickets', event)">
                    Support Tickets
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <a href="#" class="nav-item" data-tab="tools" onclick="switchTab('tools', event)">
                    System Tools
                </a>
                <a href="#" class="nav-item" data-tab="config" onclick="switchTab('config', event)">
                    Configuration
                </a>
                <a href="#" class="nav-item" data-tab="metrics" onclick="switchTab('metrics', event)">
                    Detailed Metrics
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="admin-main">
        <!-- Environment Warning (if localhost/emulator) -->
        <div id="environmentWarning" class="alert alert-warning alert-bar" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>Development Mode:</strong> Running on <span id="environmentType"></span> - data may be limited
        </div>
    
        <!-- Tab Content: Overview -->
        <div id="tab-overview" class="tab-content active">
            <div class="content-header">
                <h2 class="content-title">System Overview</h2>
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card system">
                    <div class="stat-icon"><i class="fas fa-desktop"></i></div>
                    <div class="stat-number" id="environment">---</div>
                    <div class="stat-label"><span class="status-indicator status-healthy"></span>Environment</div>
                </div>
                <div class="stat-card database">
                    <div class="stat-icon"><i class="fas fa-database"></i></div>
                    <div class="stat-number" id="dbStatus">---</div>
                    <div class="stat-label"><span class="status-indicator status-healthy"></span>Database</div>
                </div>
                <div class="stat-card performance">
                    <div class="stat-icon"><i class="fas fa-bolt"></i></div>
                    <div class="stat-number" id="cacheHitRate">---%</div>
                    <div class="stat-label">Cache Performance</div>
                </div>
                <div class="stat-card firestore">
                    <div class="stat-icon"><i class="fas fa-fire"></i></div>
                    <div class="stat-number" id="firestoreReads">---</div>
                    <div class="stat-label">Firestore Reads (24h)</div>
                </div>
                <div class="stat-card cards">
                    <div class="stat-icon"><i class="fas fa-clone"></i></div>
                    <div class="stat-number" id="cardData">---</div>
                    <div class="stat-label">Cards</div>
                </div>
                <div class="stat-card users">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-number" id="totalUsers">---</div>
                    <div class="stat-label">Total Users</div>
                </div>
            </div>
    
            <!-- Quick Actions -->
            <div class="action-grid">
                <div class="action-card">
                    <div class="action-card-header">
                        <div class="action-card-header-left">
                            <div class="action-card-icon"><i class="fas fa-heartbeat"></i></div>
                            <h3 class="action-card-title">System Health</h3>
                        </div>
                    </div>
                    <div class="action-card-description">
                        Monitor system status, check database connectivity, and view performance metrics.
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline" onclick="testDatabase()">
                            <i class="fas fa-database"></i> Test DB
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="checkSystemHealth()">
                            <i class="fas fa-heartbeat"></i> Health Check
                        </button>
                    </div>
                </div>
                
                <div class="action-card">
                    <div class="action-card-header">
                        <div class="action-card-header-left">
                            <div class="action-card-icon"><i class="fas fa-sync-alt"></i></div>
                            <h3 class="action-card-title">Cache Management</h3>
                        </div>
                    </div>
                    <div class="action-card-description">
                        Manage application cache, refresh card data, and optimize performance.
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline" onclick="refreshCards()">
                            <i class="fas fa-sync-alt"></i> Refresh Cards
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="clearCache()">
                            <i class="fas fa-broom"></i> Clear Cache
                        </button>
                    </div>
                </div>
                
                <div class="action-card">
                    <div class="action-card-header">
                        <div class="action-card-header-left">
                            <div class="action-card-icon"><i class="fas fa-chart-bar"></i></div>
                            <h3 class="action-card-title">Reports & Analytics</h3>
                        </div>
                    </div>
                    <div class="action-card-description">
                        View detailed metrics, usage statistics, and system analytics.
                    </div>
                    <div class="action-buttons">
                        <a href="/internal/firestore-usage" class="btn btn-sm btn-outline">
                            <i class="fas fa-chart-bar"></i> Usage Stats
                        </a>
                        <a href="{{ url_for('admin.metrics_dashboard') }}" class="btn btn-sm btn-outline">
                            <i class="fas fa-tachometer-alt"></i> Metrics
                        </a>
                    </div>
                </div>
                
            </div>
    
            <!-- Firestore Usage Monitor -->
            <div class="info-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="fas fa-database"></i> Database Usage Today
                    </h3>
                </div>
                <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                    <div class="stat-card" style="padding: 0.5rem;">
                        <div class="stat-icon" style="font-size: 1rem;"><i class="fas fa-book-open"></i></div>
                        <div class="stat-number" id="dbReads" style="font-size: 1rem;">---</div>
                        <div class="stat-label" style="font-size: 0.7rem;">Reads</div>
                    </div>
                    <div class="stat-card" style="padding: 0.5rem;">
                        <div class="stat-icon" style="font-size: 1rem;"><i class="fas fa-pen"></i></div>
                        <div class="stat-number" id="dbWrites" style="font-size: 1rem;">---</div>
                        <div class="stat-label" style="font-size: 0.7rem;">Writes</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Content: Analytics -->
        <div id="tab-analytics" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Analytics Dashboard</h2>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline" onclick="refreshAnalytics()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Cost Analytics Section -->
            <div class="analytics-section">
                <h3 class="section-title">
                    <i class="fas fa-dollar-sign"></i> Cost Analytics
                </h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="card-header">
                            <h4>Daily Firestore Cost</h4>
                        </div>
                        <div class="card-body">
                            <div class="cost-display">
                                <div class="cost-amount" id="dailyCost">$0.00</div>
                                <div class="cost-progress">
                                    <div class="progress">
                                        <div class="progress-bar" id="costProgressBar" style="width: 0%"></div>
                                    </div>
                                    <div class="progress-label">Daily Limit: $2.00</div>
                                </div>
                            </div>
                            <div class="cost-details">
                                <div class="detail-item">
                                    <span class="label">Monthly Projection:</span>
                                    <span class="value" id="monthlyProjection">$0.00</span>
                                </div>
                                <div class="detail-item">
                                    <span class="label">Trend:</span>
                                    <span class="value" id="costTrend">Stable</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                            <h4 style="margin: 0; flex: 1;">Database Operations</h4>
                            <select id="timeRangeSelect" class="time-range-select" onchange="changeTimeRange()">
                                <option value="1d" selected>24 hours</option>
                                <option value="7d">7 days</option>
                                <option value="14d">14 days</option>
                                <option value="30d">30 days</option>
                                <option value="60d">60 days</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="operations-grid">
                                <div class="operation-item">
                                    <div class="op-icon"><i class="fas fa-eye"></i></div>
                                    <div class="op-value" id="dailyReads">0</div>
                                    <div class="op-label">Reads (24h)</div>
                                </div>
                                <div class="operation-item">
                                    <div class="op-icon"><i class="fas fa-edit"></i></div>
                                    <div class="op-value" id="dailyWrites">0</div>
                                    <div class="op-label">Writes (24h)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Analytics Section -->
            <div class="analytics-section">
                <h3 class="section-title">
                    <i class="fas fa-users"></i> User Analytics
                </h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="card-header">
                            <h4>Active Users</h4>
                        </div>
                        <div class="card-body">
                            <div class="user-stats-grid">
                                <div class="user-stat">
                                    <div class="stat-number" id="dailyActiveUsers">0</div>
                                    <div class="stat-label">Daily Active</div>
                                </div>
                                <div class="user-stat">
                                    <div class="stat-number" id="weeklyActiveUsers">0</div>
                                    <div class="stat-label">Weekly Active</div>
                                </div>
                                <div class="user-stat">
                                    <div class="stat-number" id="monthlyActiveUsers">0</div>
                                    <div class="stat-label">Monthly Active</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="card-header">
                            <h4>User Growth</h4>
                        </div>
                        <div class="card-body">
                            <div class="growth-stats">
                                <div class="growth-item">
                                    <span class="label">Total Users:</span>
                                    <span class="value" id="totalUsers">0</span>
                                </div>
                                <div class="growth-item">
                                    <span class="label">New Users (7d):</span>
                                    <span class="value" id="newUsers7d">0</span>
                                </div>
                                <div class="growth-item">
                                    <span class="label">Retention Rate:</span>
                                    <span class="value" id="retentionRate">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- App Usage Analytics Section -->
            <div class="analytics-section">
                <h3 class="section-title">
                    <i class="fas fa-chart-bar"></i> App Usage
                </h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="card-header">
                            <h4>Deck Activity (7 days)</h4>
                        </div>
                        <div class="card-body">
                            <div class="deck-stats">
                                <div class="deck-stat">
                                    <div class="stat-number" id="decksCreated7d">0</div>
                                    <div class="stat-label">Decks Created</div>
                                </div>
                                <div class="deck-stat">
                                    <div class="stat-number" id="publicDecks7d">0</div>
                                    <div class="stat-label">Public Decks</div>
                                </div>
                                <div class="deck-stat">
                                    <div class="stat-number" id="privateDecks7d">0</div>
                                    <div class="stat-label">Private Decks</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="card-header">
                            <h4>Popular Endpoints</h4>
                        </div>
                        <div class="card-body">
                            <div id="topEndpoints" class="endpoints-list">
                                <div class="loading-text">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Analytics Section -->
            <div class="analytics-section">
                <h3 class="section-title">
                    <i class="fas fa-tachometer-alt"></i> Performance
                </h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="card-header">
                            <h4>Response Times</h4>
                        </div>
                        <div class="card-body">
                            <div class="perf-stats">
                                <div class="perf-stat">
                                    <div class="stat-number" id="avgResponseTime">0ms</div>
                                    <div class="stat-label">Average</div>
                                </div>
                                <div class="perf-stat">
                                    <div class="stat-number" id="p95ResponseTime">0ms</div>
                                    <div class="stat-label">95th Percentile</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="card-header">
                            <h4>System Health</h4>
                        </div>
                        <div class="card-body">
                            <div class="health-stats">
                                <div class="health-item">
                                    <span class="label">Cache Hit Rate:</span>
                                    <span class="value" id="cacheHitRate">0%</span>
                                </div>
                                <div class="health-item">
                                    <span class="label">Active Alerts:</span>
                                    <span class="value" id="activeAlerts">0</span>
                                </div>
                                <div class="health-item">
                                    <span class="label">Total Requests:</span>
                                    <span class="value" id="totalRequests">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="analytics-footer">
                <small class="text-muted">
                    Last updated: <span id="analyticsTimestamp">Never</span>
                    <span id="analyticsEnvironment" class="badge badge-info" style="display: none; margin-left: 10px;">Development Data</span>
                </small>
            </div>
        </div>
        
        <!-- Tab Content: User Management -->
        <div id="tab-users" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">User Management</h2>
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="refreshUserList()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- User Search -->
            <div class="info-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="fas fa-search"></i> Search Users
                    </h3>
                </div>
                <div class="search-form">
                    <div class="input-group mb-3">
                        <input type="text" id="userSearchInput" class="form-control" 
                               placeholder="Search by email, username, or user ID..." 
                               onkeyup="handleUserSearch(event)">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="button" onclick="searchUsers()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search Results -->
            <div class="info-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="fas fa-users"></i> User Results
                    </h3>
                    <span class="badge" id="userResultCount">Search to see users</span>
                </div>
                <div id="userSearchResults">
                    <div class="text-center" style="padding: 2rem; color: #6c757d;">
                        <i class="fas fa-search"></i> Enter a search term to find users
                    </div>
                </div>
            </div>
            
            <!-- User Detail Modal (hidden by default) -->
            <div class="modal" id="userDetailModal" tabindex="-1" style="display: none;">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">User Details</h5>
                            <button type="button" class="btn-close" onclick="closeUserModal()"></button>
                        </div>
                        <div class="modal-body" id="userDetailContent">
                            <!-- User detail content will be loaded here -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Content: Content Moderation -->
        <div id="tab-content" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Content Moderation</h2>
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="loadFlaggedContent()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Moderation Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 1.5rem;">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-flag"></i></div>
                    <div class="stat-number" id="flaggedCount">---</div>
                    <div class="stat-label">Flagged Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-number" id="approvedCount">---</div>
                    <div class="stat-label">Approved Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-trash"></i></div>
                    <div class="stat-number" id="removedCount">---</div>
                    <div class="stat-label">Removed Today</div>
                </div>
            </div>
            
            <!-- Flagged Content -->
            <div class="info-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="fas fa-flag"></i> Flagged Decks
                    </h3>
                    <span class="badge" id="flaggedDecksBadge">Loading...</span>
                </div>
                <div id="flaggedDecksContent">
                    <div class="text-center" style="padding: 2rem; color: #6c757d;">
                        <i class="fas fa-spinner fa-spin"></i> Loading flagged content...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Content: System Tools -->
        <div id="tab-tools" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">System Tools</h2>
            </div>
            
            <!-- Cache Management -->
            <div class="action-grid">
                <div class="action-card">
                    <div class="action-card-header">
                        <div class="action-card-header-left">
                            <div class="action-card-icon"><i class="fas fa-database"></i></div>
                            <h3 class="action-card-title">Cache Management</h3>
                        </div>
                    </div>
                    <div class="action-card-description">
                        Manage application cache to improve performance and clear outdated data.
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-warning" onclick="clearSystemCache()">
                            <i class="fas fa-broom"></i> Clear All Cache
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="getCacheStats()">
                            <i class="fas fa-chart-pie"></i> Cache Stats
                        </button>
                    </div>
                </div>
                
                <div class="action-card">
                    <div class="action-card-header">
                        <div class="action-card-header-left">
                            <div class="action-card-icon"><i class="fas fa-wrench"></i></div>
                            <h3 class="action-card-title">Maintenance Mode</h3>
                        </div>
                    </div>
                    <div class="action-card-description">
                        Enable maintenance mode to perform system updates safely.
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-danger" onclick="toggleMaintenanceMode(true)">
                            <i class="fas fa-pause"></i> Enable Maintenance
                        </button>
                        <button class="btn btn-sm btn-success" onclick="toggleMaintenanceMode(false)">
                            <i class="fas fa-play"></i> Disable Maintenance
                        </button>
                    </div>
                </div>
                
                <div class="action-card">
                    <div class="action-card-header">
                        <div class="action-card-header-left">
                            <div class="action-card-icon"><i class="fas fa-stethoscope"></i></div>
                            <h3 class="action-card-title">System Diagnostics</h3>
                        </div>
                    </div>
                    <div class="action-card-description">
                        Run system health checks and performance diagnostics.
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline" onclick="runDiagnostics()">
                            <i class="fas fa-stethoscope"></i> Run Diagnostics
                        </button>
                        <a href="/internal/firestore-usage" class="btn btn-sm btn-outline">
                            <i class="fas fa-database"></i> DB Usage
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Content: Configuration -->
        <div id="tab-config" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Configuration</h2>
            </div>
            
            <div class="info-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="fas fa-cogs"></i> System Configuration
                    </h3>
                </div>
                
                <div class="config-section">
                    <h5>Environment Information</h5>
                    <table class="data-table">
                        <tr><td>Environment</td><td id="configEnvironment">Loading...</td></tr>
                        <tr><td>Database Status</td><td id="configDbStatus">Loading...</td></tr>
                        <tr><td>Cache Status</td><td id="configCacheStatus">Loading...</td></tr>
                    </table>
                </div>
            </div>
            
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Note:</strong> Advanced configuration features (feature flags, rate limiting) will be added in a future update.
            </div>
        </div>
        
        <!-- Tab Content: Support Tickets -->
        <div id="tab-tickets" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Support Tickets</h2>
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="loadSupportTickets()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="exportTickets()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            
            <!-- Ticket Statistics -->
            <div class="support-stats">
                <div class="stat-card stat-total">
                    <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
                    <div class="stat-info">
                        <div class="stat-number" id="totalTickets">---</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
                <div class="stat-card stat-new">
                    <div class="stat-icon"><i class="fas fa-bell"></i></div>
                    <div class="stat-info">
                        <div class="stat-number" id="newTickets">---</div>
                        <div class="stat-label">New</div>
                    </div>
                </div>
                <div class="stat-card stat-resolved">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info">
                        <div class="stat-number" id="resolvedTickets">---</div>
                        <div class="stat-label">Resolved</div>
                    </div>
                </div>
            </div>
            
            <!-- Ticket Controls -->
            <div class="ticket-controls">
                <div class="ticket-tabs">
                    <button class="ticket-tab active" data-status="all" onclick="filterTicketsByStatus('all')">
                        All Tickets
                    </button>
                    <button class="ticket-tab" data-status="new" onclick="filterTicketsByStatus('new')">
                        Open <span class="tab-count" id="tabCountNew">0</span>
                    </button>
                    <button class="ticket-tab" data-status="closed" onclick="filterTicketsByStatus('closed')">
                        Closed <span class="tab-count" id="tabCountClosed">0</span>
                    </button>
                </div>
                
                <div class="ticket-search">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="ticketSearch" placeholder="Search tickets..." oninput="debouncedSearch(event)">
                        <button class="clear-search" onclick="clearTicketSearch()" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <select class="sort-select" onchange="sortTickets()">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="priority">By Status</option>
                    </select>
                </div>
            </div>
            
            <!-- Tickets Table -->
            <div class="tickets-container">
                <div id="ticketsContent">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i> Loading tickets...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Content: Metrics -->
        <div id="tab-metrics" class="tab-content">
            <div class="content-header">
                <h2 class="content-title">Detailed Metrics</h2>
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="loadMetricsData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Performance Metrics -->
            <div class="info-panel">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="fas fa-tachometer-alt"></i> Performance Metrics
                    </h3>
                </div>
                <div id="performanceMetrics">
                    <div class="text-center" style="padding: 2rem; color: #6c757d;">
                        <i class="fas fa-spinner fa-spin"></i> Loading metrics...
                    </div>
                </div>
            </div>
            
            <!-- Firestore Usage -->
            <div class="info-panel" style="margin-top: 1.5rem;">
                <div class="panel-header">
                    <h3 class="panel-title">
                        <i class="fas fa-database"></i> Database Usage
                    </h3>
                </div>
                <div id="firestoreMetrics">
                    <div class="text-center" style="padding: 2rem; color: #6c757d;">
                        <i class="fas fa-spinner fa-spin"></i> Loading database metrics...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div id="replyModal" class="reply-modal">
    <div class="reply-modal-content">
        <div class="reply-modal-header">
            <h5 class="reply-modal-title">Reply to Support Ticket</h5>
            <button class="reply-modal-close" onclick="closeReplyModal()">&times;</button>
        </div>
        <div class="reply-modal-body">
            <div class="original-ticket" id="originalTicketInfo">
                <div class="original-ticket-header">
                    <div>
                        <strong id="originalTicketSubject"></strong>
                        <div style="font-size: 0.875rem; color: #6c757d;" id="originalTicketMeta"></div>
                    </div>
                    <span id="originalTicketStatus"></span>
                </div>
                <div class="original-ticket-content" id="originalTicketMessage"></div>
            </div>
            
            <form class="reply-form" onsubmit="sendReply(event)">
                <input type="hidden" id="replyTicketId" value="">
                <div class="form-group">
                    <label for="replyMessage">Your Reply:</label>
                    <textarea id="replyMessage" placeholder="Type your response here..." required></textarea>
                </div>
            </form>
        </div>
        <div class="reply-modal-footer">
            <button class="btn btn-outline" onclick="closeReplyModal()">Cancel</button>
            <button class="btn btn-reply" onclick="sendReply(event)">
                <i class="fas fa-paper-plane"></i> Send Reply & Close
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Restore saved time range for analytics
    const savedTimeRange = localStorage.getItem('adminAnalyticsTimeRange') || '1d';
    const timeRangeSelect = document.getElementById('timeRangeSelect');
    if (timeRangeSelect) {
        timeRangeSelect.value = savedTimeRange;
    }
    
    // Restore the previously active tab from localStorage
    const savedTab = localStorage.getItem('adminActiveTab') || 'overview';
    
    // Find and activate the saved tab
    const savedNavItem = document.querySelector(`.nav-item[data-tab="${savedTab}"]`);
    if (savedNavItem) {
        // Remove default active class from all items
        document.querySelectorAll('.admin-sidebar .nav-item').forEach(item => item.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active class to saved tab
        savedNavItem.classList.add('active');
        const tabContent = document.getElementById('tab-' + savedTab);
        if (tabContent) {
            tabContent.classList.add('active');
        }
        
        // Load content for the saved tab
        if (savedTab === 'overview') {
            loadDashboardData();
        } else if (savedTab === 'content') {
            loadFlaggedContent();
        } else if (savedTab === 'config') {
            loadConfigurationData();
        } else if (savedTab === 'tickets') {
            loadSupportTickets();
        } else if (savedTab === 'users') {
            loadUserManagementData();
        } else if (savedTab === 'analytics') {
            loadAnalyticsData();
        } else if (savedTab === 'tools') {
            loadSystemToolsData();
        } else if (savedTab === 'metrics') {
            loadMetricsData();
        }
    } else {
        // Fallback to default
        loadDashboardData();
    }
});

function switchTab(tabName, event) {
    // Prevent default link behavior
    if (event) {
        event.preventDefault();
    }
    
    // Save the active tab to localStorage
    localStorage.setItem('adminActiveTab', tabName);
    
    // Remove active class from all nav items and tab contents
    document.querySelectorAll('.admin-sidebar .nav-item').forEach(item => item.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Add active class to clicked nav item and corresponding tab content
    const navItem = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
    if (navItem) {
        navItem.classList.add('active');
    }
    
    const tabContent = document.getElementById('tab-' + tabName);
    if (tabContent) {
        tabContent.classList.add('active');
    }
    
    // Update page title context
    const contentTitle = document.querySelector('#tab-' + tabName + ' .content-title');
    if (contentTitle) {
        document.title = contentTitle.textContent + ' - Admin Panel';
    }
    
    // Load specific content when tabs are selected
    if (tabName === 'content') {
        loadFlaggedContent();
    } else if (tabName === 'config') {
        loadConfigurationData();
    } else if (tabName === 'tickets') {
        loadSupportTickets();
    } else if (tabName === 'analytics') {
        loadAnalyticsData();
    } else if (tabName === 'metrics') {
        loadMetricsData();
    }
}

function loadConfigurationData() {
    // Update configuration tab with current data
    const elements = {
        'configEnvironment': document.getElementById('environment').textContent,
        'configDbStatus': document.getElementById('dbStatus').textContent,
        'configCacheStatus': document.getElementById('cacheHitRate').textContent + ' hit rate'
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = elements[id];
        }
    });
}

function adjustEnvironmentWarning() {
    // Warning positioning is now handled by CSS
    const warning = document.getElementById('environmentWarning');
    if (warning && warning.style.display !== 'none') {
        warning.classList.add('alert-bar');
    }
}

function refreshDashboard() {
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    btn.disabled = true;
    
    loadDashboardData().finally(() => {
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }, 1000);
    });
}

async function loadDashboardData() {
    try {
        // Load metrics summary
        const response = await fetch('/admin/api/metrics/summary');
        if (response.ok) {
            const data = await response.json();
            
            // Load dashboard features
            loadDatabaseUsage();
            
            // Show environment warning if localhost/emulator
            if (data.is_emulator) {
                document.getElementById('environmentWarning').style.display = 'block';
                document.getElementById('environmentType').textContent = data.environment;
                adjustEnvironmentWarning();
            }
            
            // Update meaningful debugging metrics
            document.getElementById('environment').textContent = data.environment || 'Unknown';
            const dbConnected = data.system_health?.database;
            document.getElementById('dbStatus').textContent = dbConnected ? 'Online' : 'Error';
            
            // Update status indicators
            updateStatusIndicators(data);
            
            const cacheRate = data.cache_hit_rate ? Math.round(data.cache_hit_rate * 100) + '%' : '0%';
            document.getElementById('cacheHitRate').textContent = cacheRate;
            // cacheRate element was removed with System Status panel
            const cacheRateEl = document.getElementById('cacheRate');
            if (cacheRateEl) cacheRateEl.textContent = cacheRate;
            
            // Update Firestore reads instead of open tickets on dashboard
            const firestoreReadsElement = document.getElementById('firestoreReads');
            if (firestoreReadsElement) {
                firestoreReadsElement.textContent = data.firestore_reads_24h || '0';
            }
            
            // Card collection info - show meaningful data based on environment
            const cardInfo = data.is_emulator ? 
                `${data.total_cards || 0}` : 
                `${data.total_cards || 0}`;
            document.getElementById('cardData').textContent = cardInfo;
            
            // Total users count
            document.getElementById('totalUsers').textContent = data.total_users || '0';
            
            // Update status panel timestamps
            const now = new Date();
            // lastDbCheck element was removed with System Status panel
            const lastDbCheckEl = document.getElementById('lastDbCheck');
            if (lastDbCheckEl) lastDbCheckEl.textContent = now.toLocaleTimeString();
        } else {
            console.error('Failed to load metrics:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('Failed to load dashboard data:', error);
        // Set default values for elements that exist
        
        // Try to get more detailed error info
        if (error.response) {
            console.error('Response status:', error.response.status);
            console.error('Response text:', await error.response.text());
        }
        
        // Show error state in UI
        showErrorState();
    }
}

function updateStatusIndicators(data) {
    const indicators = {
        'system': data.system_health?.cache ? 'healthy' : 'error',
        'database': data.system_health?.database ? 'healthy' : 'error',
        'performance': (data.cache_hit_rate || 0) > 0.8 ? 'healthy' : 'warning'
    };
    
    Object.keys(indicators).forEach(type => {
        const card = document.querySelector(`.stat-card.${type}`);
        if (card) {
            const indicator = card.querySelector('.status-indicator');
            if (indicator) {
                indicator.className = `status-indicator status-${indicators[type]}`;
            }
        }
    });
}

function showErrorState() {
    document.getElementById('environment').textContent = 'Error';
    document.getElementById('dbStatus').textContent = 'Unknown';
    document.getElementById('cacheHitRate').textContent = '0%';
    const firestoreReadsElement = document.getElementById('firestoreReads');
    if (firestoreReadsElement) {
        firestoreReadsElement.textContent = '?';
    }
    document.getElementById('cardData').textContent = '?';
    document.getElementById('totalUsers').textContent = '?';
}


async function refreshCards() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/refresh-cards', {
            method: 'POST',
            headers: {
                'X-Refresh-Key': 'admin-refresh'
            }
        });
        
        if (response.ok) {
            btn.innerHTML = '<i class="fas fa-check"></i> Refreshed!';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        } else {
            throw new Error('Failed to refresh');
        }
    } catch (error) {
        btn.innerHTML = '<i class="fas fa-times"></i> Failed';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    }
}

async function testDatabase() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
    
    try {
        // Test database connectivity by calling metrics endpoint
        const response = await fetch('/admin/api/metrics/summary');
        if (response.ok) {
            const data = await response.json();
            const dbStatus = data.system_health?.database ? 'Connected' : 'Error';
            btn.innerHTML = `<i class="fas fa-check"></i> ${dbStatus}`;
        } else {
            throw new Error('API call failed');
        }
    } catch (error) {
        btn.innerHTML = '<i class="fas fa-times"></i> Failed';
    }
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 2000);
}

async function checkSystemHealth() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/health');
        if (response.ok) {
            btn.innerHTML = '<i class="fas fa-check"></i> Healthy';
        } else {
            throw new Error('Health check failed');
        }
    } catch (error) {
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Issues';
    }
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 2000);
}

async function clearCache() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    if (!confirm('Are you sure you want to clear the cache?')) {
        return;
    }
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
    btn.disabled = true;
    
    try {
        // For now, just reload the page to refresh data
        btn.innerHTML = '<i class="fas fa-check"></i> Cleared!';
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    } catch (error) {
        btn.innerHTML = '<i class="fas fa-times"></i> Failed';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    }
}

// User Management Functions
function handleUserSearch(event) {
    if (event.key === 'Enter') {
        searchUsers();
    }
}

async function searchUsers() {
    const query = document.getElementById('userSearchInput').value.trim();
    const resultsContainer = document.getElementById('userSearchResults');
    const countBadge = document.getElementById('userResultCount');
    
    if (!query) {
        resultsContainer.innerHTML = '<div class="text-center" style="padding: 2rem; color: #6c757d;"><i class="fas fa-search"></i> Enter a search term to find users</div>';
        countBadge.textContent = 'Search to see users';
        return;
    }
    
    resultsContainer.innerHTML = '<div class="text-center" style="padding: 2rem; color: #6c757d;"><i class="fas fa-spinner fa-spin"></i> Searching users...</div>';
    
    try {
        const response = await fetch(`/admin/api/users/search?q=${encodeURIComponent(query)}&limit=20`);
        if (response.ok) {
            const data = await response.json();
            displayUserResults(data.users);
            countBadge.textContent = `${data.total} user${data.total !== 1 ? 's' : ''} found`;
        } else {
            throw new Error('Search failed');
        }
    } catch (error) {
        resultsContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error searching users</div>';
        countBadge.textContent = 'Search failed';
    }
}

function displayUserResults(users) {
    const container = document.getElementById('userSearchResults');
    
    if (users.length === 0) {
        container.innerHTML = '<div class="text-center" style="padding: 2rem; color: #6c757d;"><i class="fas fa-user-slash"></i> No users found</div>';
        return;
    }
    
    let html = '<table class="data-table"><thead><tr><th>User</th><th>Email</th><th class="mobile-hide">Last Login</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    
    users.forEach(user => {
        const lastLogin = user.last_login ? new Date(user.last_login.seconds * 1000).toLocaleDateString() : 'Never';
        const statusBadge = user.is_banned ? '<span class="badge badge-danger">Banned</span>' : '<span class="badge badge-success">Active</span>';
        
        html += `
            <tr>
                <td><strong>${user.username || 'No username'}</strong></td>
                <td>${user.email}</td>
                <td class="mobile-hide">${lastLogin}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline" onclick="viewUserDetails('${user.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                    ${!user.is_banned ? 
                        `<button class="btn btn-sm btn-warning" onclick="banUser('${user.id}', true)">
                            <i class="fas fa-ban"></i> Ban
                        </button>` :
                        `<button class="btn btn-sm btn-success" onclick="banUser('${user.id}', false)">
                            <i class="fas fa-check"></i> Unban
                        </button>`
                    }
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function viewUserDetails(userId) {
    const modal = document.getElementById('userDetailModal');
    const content = document.getElementById('userDetailContent');
    
    content.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading user details...</div>';
    modal.style.display = 'block';
    
    try {
        const response = await fetch(`/admin/api/users/${userId}/activity`);
        if (response.ok) {
            const user = await response.json();
            displayUserDetails(user);
        } else {
            throw new Error('Failed to load user details');
        }
    } catch (error) {
        content.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error loading user details</div>';
    }
}

function displayUserDetails(user) {
    const content = document.getElementById('userDetailContent');
    const createdAt = user.created_at ? new Date(user.created_at.seconds * 1000).toLocaleDateString() : 'Unknown';
    const lastLogin = user.last_login ? new Date(user.last_login.seconds * 1000).toLocaleString() : 'Never';
    
    let recentDecksHtml = '';
    if (user.recent_decks && user.recent_decks.length > 0) {
        recentDecksHtml = user.recent_decks.map(deck => 
            `<li>${deck.name} ${deck.is_public ? '(Public)' : '(Private)'}</li>`
        ).join('');
    } else {
        recentDecksHtml = '<li>No decks found</li>';
    }
    
    content.innerHTML = `
        <div class="user-details">
            <h5><i class="fas fa-user"></i> ${user.username || 'No username'}</h5>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>User ID:</strong> <code>${user.user_id}</code></p>
            <p><strong>Account Created:</strong> ${createdAt}</p>
            <p><strong>Last Login:</strong> ${lastLogin}</p>
            <p><strong>Status:</strong> ${user.is_banned ? `<span class="badge badge-danger">Banned</span> - ${user.ban_reason}` : '<span class="badge badge-success">Active</span>'}</p>
            <p><strong>Total Decks:</strong> ${user.deck_count}</p>
            
            <h6>Recent Decks:</h6>
            <ul>${recentDecksHtml}</ul>
            
            <div class="mt-3">
                ${!user.is_banned ? 
                    `<button class="btn btn-warning" onclick="banUser('${user.user_id}', true); closeUserModal();">
                        <i class="fas fa-ban"></i> Ban User
                    </button>` :
                    `<button class="btn btn-success" onclick="banUser('${user.user_id}', false); closeUserModal();">
                        <i class="fas fa-check"></i> Unban User
                    </button>`
                }
            </div>
        </div>
    `;
}

function closeUserModal() {
    document.getElementById('userDetailModal').style.display = 'none';
}

async function banUser(userId, shouldBan) {
    const action = shouldBan ? 'ban' : 'unban';
    const reason = shouldBan ? prompt('Enter ban reason (optional):') || 'Admin action' : '';
    
    if (shouldBan && !confirm(`Are you sure you want to ban this user?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/users/${userId}/ban`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({banned: shouldBan, reason: reason})
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(result.message);
            // Refresh current search results
            const searchInput = document.getElementById('userSearchInput');
            if (searchInput.value) {
                searchUsers();
            }
        } else {
            throw new Error('Action failed');
        }
    } catch (error) {
        alert(`Failed to ${action} user`);
    }
}

function refreshUserList() {
    document.getElementById('userSearchInput').value = '';
    document.getElementById('userSearchResults').innerHTML = '<div class="text-center" style="padding: 2rem; color: #6c757d;"><i class="fas fa-search"></i> Enter a search term to find users</div>';
    document.getElementById('userResultCount').textContent = 'Search to see users';
}

// System Tools Functions
async function clearSystemCache() {
    if (!confirm('Are you sure you want to clear all cache? This may temporarily slow down the application.')) {
        return;
    }
    
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/admin/api/system/cache/clear', {method: 'POST'});
        if (response.ok) {
            const result = await response.json();
            btn.innerHTML = '<i class="fas fa-check"></i> Cleared!';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 2000);
        } else {
            throw new Error('Failed to clear cache');
        }
    } catch (error) {
        btn.innerHTML = '<i class="fas fa-times"></i> Failed';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }, 2000);
    }
}

async function toggleMaintenanceMode(enabled) {
    const action = enabled ? 'enable' : 'disable';
    const message = enabled ? prompt('Enter maintenance message:') || 'System is under maintenance. Please try again later.' : '';
    
    if (!confirm(`Are you sure you want to ${action} maintenance mode?`)) {
        return;
    }
    
    try {
        const response = await fetch('/admin/api/system/maintenance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({enabled: enabled, message: message})
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(result.message);
        } else {
            throw new Error('Failed to toggle maintenance mode');
        }
    } catch (error) {
        alert(`Failed to ${action} maintenance mode`);
    }
}

function getCacheStats() {
    // Redirect to existing cache stats page
    window.open('/internal/firestore-usage', '_blank');
}

function runDiagnostics() {
    // Run multiple system checks
    const checks = [
        {name: 'Database Connection', func: testDatabase},
        {name: 'System Health', func: checkSystemHealth}
    ];
    
    let results = 'System Diagnostics Results:\n\n';
    checks.forEach(check => {
        try {
            check.func();
            results += ` ${check.name}: OK\n`;
        } catch (error) {
            results += ` ${check.name}: Error\n`;
        }
    });
    
    alert(results);
}

// Content Moderation Functions
async function loadFlaggedContent() {
    const contentContainer = document.getElementById('flaggedDecksContent');
    const badge = document.getElementById('flaggedDecksBadge');
    
    contentContainer.innerHTML = '<div class="text-center" style="padding: 2rem; color: #6c757d;"><i class="fas fa-spinner fa-spin"></i> Loading flagged content...</div>';
    badge.textContent = 'Loading...';
    
    try {
        const response = await fetch('/admin/api/content/decks/flagged');
        if (response.ok) {
            const data = await response.json();
            displayFlaggedDecks(data.flagged_decks);
            badge.textContent = `${data.total} items`;
            
            // Update stats
            document.getElementById('flaggedCount').textContent = data.total;
            document.getElementById('approvedCount').textContent = '0'; // Placeholder
            document.getElementById('removedCount').textContent = '0'; // Placeholder
        } else {
            throw new Error('Failed to load flagged content');
        }
    } catch (error) {
        contentContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error loading flagged content</div>';
        badge.textContent = 'Error';
    }
}

function displayFlaggedDecks(decks) {
    const container = document.getElementById('flaggedDecksContent');
    
    if (decks.length === 0) {
        container.innerHTML = '<div class="text-center" style="padding: 2rem; color: #6c757d;"><i class="fas fa-check-circle"></i> No flagged content found</div>';
        return;
    }
    
    let html = '<table class="data-table"><thead><tr><th>Deck Name</th><th>Owner</th><th class="mobile-hide">Created</th><th>Reason</th><th>Actions</th></tr></thead><tbody>';
    
    decks.forEach(deck => {
        const createdAt = deck.created_at ? new Date(deck.created_at.seconds * 1000).toLocaleDateString() : 'Unknown';
        
        html += `
            <tr id="deck-${deck.id}">
                <td><strong>${deck.name}</strong> <small>(${deck.card_count} cards)</small></td>
                <td>${deck.owner_email}</td>
                <td class="mobile-hide">${createdAt}</td>
                <td><span class="badge badge-warning">${deck.flag_reason}</span></td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="moderateDeck('${deck.id}', 'approve')" title="Approve">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="moderateDeck('${deck.id}', 'hide')" title="Hide">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="moderateDeck('${deck.id}', 'delete')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                    <a href="/decks/${deck.id}" target="_blank" class="btn btn-sm btn-outline" title="View Deck">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function moderateDeck(deckId, action) {
    const actionNames = {
        'approve': 'approve',
        'hide': 'hide',
        'delete': 'delete'
    };
    
    const actionName = actionNames[action];
    
    if (action === 'delete' && !confirm('Are you sure you want to permanently delete this deck? This action cannot be undone.')) {
        return;
    }
    
    if (action === 'hide' && !confirm('This will make the deck private. Continue?')) {
        return;
    }
    
    const reason = action !== 'approve' ? prompt('Enter moderation reason (optional):') || 'Admin action' : '';
    
    try {
        const response = await fetch(`/admin/api/content/decks/${deckId}/moderate`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: action, reason: reason})
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Remove the row from the table or update it
            const row = document.getElementById(`deck-${deckId}`);
            if (row) {
                if (action === 'delete') {
                    row.remove();
                } else {
                    // Update the row to show it's been moderated
                    const reasonCell = row.children[3];
                    reasonCell.innerHTML = `<span class="badge badge-success">Moderated: ${actionName}d</span>`;
                    
                    // Disable action buttons
                    const actionButtons = row.querySelectorAll('button');
                    actionButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                    });
                }
            }
            
            // Show success message
            window.showGlobalToast(`Deck successfully ${actionName}d`, 'success');
            
        } else {
            throw new Error('Moderation action failed');
        }
    } catch (error) {
        window.showGlobalToast(`Failed to ${actionName} deck`, 'error');
    }
}

// Removed showNotification - now using window.showGlobalToast from base.html


// Support Tickets Variables
let allTickets = [];
let currentFilter = 'all';
let currentSort = 'newest';

async function loadSupportTickets() {
    console.log('Loading support tickets...');
    
    const container = document.getElementById('ticketsContent');
    container.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading tickets...</div>';
    
    try {
        const response = await fetch('/admin/api/support-tickets');
        console.log('Support tickets response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Support tickets data:', data);
            
            allTickets = data.tickets || [];
            console.log(`Loaded ${allTickets.length} tickets`);
            
            // Update statistics
            updateTicketStatistics();
            
            // Display tickets
            displayTicketsTable();
            
        } else {
            throw new Error(`HTTP ${response.status}: Failed to load tickets`);
        }
    } catch (error) {
        console.error('Error loading support tickets:', error);
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <div>Error loading tickets: ${error.message}</div>
                <button class="btn btn-outline btn-sm" onclick="loadSupportTickets()" style="margin-top: 1rem;">
                    <i class="fas fa-refresh"></i> Try Again
                </button>
            </div>
        `;
    }
}

function updateTicketStatistics() {
    const newCount = allTickets.filter(t => t.status === 'new').length;
    const inProgressCount = allTickets.filter(t => t.status === 'in_progress').length;
    const resolvedCount = allTickets.filter(t => t.status === 'resolved').length;
    const closedCount = allTickets.filter(t => t.status === 'closed').length;
    
    // Update main statistics
    document.getElementById('totalTickets').textContent = allTickets.length;
    document.getElementById('newTickets').textContent = newCount;
    document.getElementById('resolvedTickets').textContent = resolvedCount;
    
    // Update tab counts
    const tabCountNew = document.getElementById('tabCountNew');
    const tabCountClosed = document.getElementById('tabCountClosed');
    if (tabCountNew) tabCountNew.textContent = newCount + inProgressCount;
    if (tabCountClosed) tabCountClosed.textContent = resolvedCount + closedCount;
}

function displayTicketsTable() {
    const container = document.getElementById('ticketsContent');
    
    if (allTickets.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <div>No support tickets found</div>
            </div>
        `;
        return;
    }
    
    // Filter and sort tickets
    let filteredTickets = getFilteredTickets();
    
    // Create table
    let html = `
        <table class="tickets-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Subject</th>
                    <th>Email</th>
                    <th class="mobile-hide">Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    filteredTickets.forEach(ticket => {
        html += generateTicketRow(ticket);
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function getFilteredTickets() {
    let filtered = [...allTickets];
    
    // Apply status filter
    if (currentFilter === 'new') {
        filtered = filtered.filter(t => t.status === 'new' || t.status === 'in_progress');
    } else if (currentFilter === 'closed') {
        filtered = filtered.filter(t => t.status === 'resolved' || t.status === 'closed');
    }
    
    // Apply search filter
    const searchTerm = document.getElementById('ticketSearch')?.value?.toLowerCase();
    if (searchTerm) {
        filtered = filtered.filter(ticket => 
            ticket.subject?.toLowerCase().includes(searchTerm) ||
            ticket.email?.toLowerCase().includes(searchTerm) ||
            ticket.name?.toLowerCase().includes(searchTerm) ||
            ticket.message?.toLowerCase().includes(searchTerm) ||
            ticket.id?.toLowerCase().includes(searchTerm)
        );
    }
    
    // Apply sorting
    filtered.sort((a, b) => {
        switch(currentSort) {
            case 'oldest':
                return new Date(a.timestamp) - new Date(b.timestamp);
            case 'priority':
                const statusOrder = { 'new': 0, 'in_progress': 1, 'resolved': 2, 'closed': 3 };
                return statusOrder[a.status] - statusOrder[b.status];
            default: // newest
                return new Date(b.timestamp) - new Date(a.timestamp);
        }
    });
    
    return filtered;
}

function generateTicketRow(ticket) {
    const date = ticket.formatted_date || 'Unknown';
    const statusClass = ticket.status || 'new';
    const statusText = ticket.status?.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'New';
    
    // Create a preview of the message (first 60 characters for better display)
    const messagePreview = ticket.message ? 
        (ticket.message.length > 60 ? ticket.message.substring(0, 60) + '...' : ticket.message) : 
        'No message';
    
    const hasLongMessage = ticket.message && ticket.message.length > 60;
    const expandButtonClass = hasLongMessage ? '' : 'style="display: none;"';
    
    return `
        <tr class="ticket-row" data-ticket-id="${ticket.id}">
            <td><span class="ticket-id">#${ticket.id?.substring(0, 8) || 'N/A'}</span></td>
            <td>
                <div class="ticket-subject-container">
                    <div class="ticket-subject">${ticket.subject || 'No subject'}</div>
                    <div class="ticket-preview">${messagePreview}</div>
                    <button class="btn-expand" onclick="toggleTicketContent('${ticket.id}')" ${expandButtonClass} title="Show full message">
                        <i class="fas fa-chevron-down"></i> Show More
                    </button>
                </div>
            </td>
            <td><span class="ticket-email" onclick="copyToClipboard('${ticket.email}')" title="Click to copy">${ticket.email || 'No email'}</span></td>
            <td class="mobile-hide"><span class="ticket-date">${date}</span></td>
            <td><span class="status-badge ${statusClass}"><i class="fas fa-circle"></i> ${statusText}</span></td>
            <td style="text-align: center;">
                <div class="ticket-actions">
                    <button class="btn btn-reply" onclick="openReplyModal('${ticket.id}')" title="Reply to ticket">
                        <i class="fas fa-reply"></i> Reply
                    </button>
                    ${ticket.status === 'new' || ticket.status === 'in_progress' ? 
                        `<button class="btn btn-status" onclick="updateTicketStatus('${ticket.id}', 'resolved')" title="Mark as resolved">
                            <i class="fas fa-check"></i> Resolve
                        </button>` :
                        `<button class="btn btn-status" onclick="updateTicketStatus('${ticket.id}', 'new')" title="Reopen ticket">
                            <i class="fas fa-undo"></i> Reopen
                        </button>`
                    }
                </div>
            </td>
        </tr>
        <tr class="ticket-content-row" id="content-${ticket.id}" style="display: none;">
            <td colspan="6">
                <div class="ticket-content-detail">
                    <div class="content-header">
                        <strong>Full Message:</strong>
                        <button class="btn-close-content" onclick="toggleTicketContent('${ticket.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="content-message">${ticket.message || 'No message available'}</div>
                </div>
            </td>
        </tr>
    `;
}

// Filter and control functions
function filterTicketsByStatus(status) {
    currentFilter = status;
    
    // Update active tab
    document.querySelectorAll('.ticket-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-status="${status}"]`).classList.add('active');
    
    displayTicketsTable();
}

function sortTickets() {
    const sortSelect = document.querySelector('.sort-select');
    currentSort = sortSelect.value;
    displayTicketsTable();
}

// Debounce timer for search
let searchTimeout;

function debouncedSearch(event) {
    // Clear the previous timeout
    clearTimeout(searchTimeout);
    
    // Set a new timeout to search after 300ms of no typing
    searchTimeout = setTimeout(() => {
        searchTickets();
    }, 300);
}

function searchTickets() {
    const searchTerm = document.getElementById('ticketSearch').value;
    const clearButton = document.querySelector('.clear-search');
    
    if (searchTerm) {
        clearButton.style.display = 'block';
    } else {
        clearButton.style.display = 'none';
    }
    
    displayTicketsTable();
}

function clearTicketSearch() {
    document.getElementById('ticketSearch').value = '';
    document.querySelector('.clear-search').style.display = 'none';
    displayTicketsTable();
}

// Ticket content expansion functions
function toggleTicketContent(ticketId) {
    const contentRow = document.getElementById(`content-${ticketId}`);
    const ticketRow = document.querySelector(`[data-ticket-id="${ticketId}"]`);
    const expandBtn = ticketRow.querySelector('.btn-expand');
    
    if (contentRow.style.display === 'none') {
        contentRow.style.display = 'table-row';
        expandBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Show Less';
        expandBtn.title = 'Hide full message';
    } else {
        contentRow.style.display = 'none';
        expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Show More';
        expandBtn.title = 'Show full message';
    }
}

// Reply modal functions
function openReplyModal(ticketId) {
    const ticket = allTickets.find(t => t.id === ticketId);
    if (!ticket) return;
    
    // Populate modal with ticket data
    document.getElementById('originalTicketSubject').textContent = ticket.subject || 'No subject';
    document.getElementById('originalTicketMeta').textContent = `From: ${ticket.name || 'Unknown'} <${ticket.email || 'No email'}>  ${ticket.formatted_date || 'Unknown date'}`;
    document.getElementById('originalTicketStatus').innerHTML = `<span class="status-badge ${ticket.status || 'new'}">${ticket.status?.replace('_', ' ').toUpperCase() || 'NEW'}</span>`;
    document.getElementById('originalTicketMessage').textContent = ticket.message || 'No message content';
    document.getElementById('replyTicketId').value = ticketId;
    document.getElementById('replyMessage').value = '';
    
    // Show modal
    document.getElementById('replyModal').classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Focus on textarea
    setTimeout(() => document.getElementById('replyMessage').focus(), 300);
}

function closeReplyModal() {
    document.getElementById('replyModal').classList.remove('show');
    document.body.style.overflow = '';
}

async function sendReply(event) {
    event.preventDefault();
    
    const ticketId = document.getElementById('replyTicketId').value;
    const replyMessage = document.getElementById('replyMessage').value.trim();
    
    if (!replyMessage) {
        window.showGlobalToast('Please enter a reply message', 'error');
        return;
    }
    
    const replyBtn = document.querySelector('.btn-reply');
    const originalText = replyBtn.innerHTML;
    replyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    replyBtn.disabled = true;
    
    try {
        const response = await fetch(`/admin/api/support-tickets/${ticketId}/reply`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                reply_message: replyMessage,
                close_ticket: true
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            if (result.email_sent) {
                window.showGlobalToast('Reply sent successfully and email delivered!', 'success');
            } else if (result.email_error) {
                window.showGlobalToast(`Reply saved but email failed: ${result.email_error}`, 'warning');
            } else {
                window.showGlobalToast('Reply sent successfully!', 'success');
            }
            
            closeReplyModal();
            loadSupportTickets(); // Reload tickets
        } else {
            throw new Error(result.error || 'Failed to send reply');
        }
    } catch (error) {
        window.showGlobalToast('Failed to send reply: ' + error.message, 'error');
    } finally {
        replyBtn.innerHTML = originalText;
        replyBtn.disabled = false;
    }
}

async function updateTicketStatus(ticketId, newStatus) {
    try {
        const response = await fetch(`/admin/api/support-tickets/${ticketId}/status`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status: newStatus})
        });
        
        if (response.ok) {
            loadSupportTickets(); // Reload tickets
        } else {
            throw new Error('Failed to update status');
        }
    } catch (error) {
        window.showGlobalToast('Failed to update ticket status', 'error');
    }
}

// Utility functions
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        window.showGlobalToast('Email copied to clipboard', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        window.showGlobalToast('Email copied to clipboard', 'success');
    });
}

function exportTickets() {
    const csvContent = [
        ['ID', 'Subject', 'Email', 'Name', 'Status', 'Date', 'Message'],
        ...allTickets.map(ticket => [
            ticket.id || '',
            ticket.subject || '',
            ticket.email || '',
            ticket.name || '',
            ticket.status || '',
            ticket.formatted_date || '',
            (ticket.message || '').replace(/"/g, '""')
        ])
    ].map(row => row.map(field => `"${field}"`).join(','))
     .join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `support_tickets_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('replyModal');
    if (event.target === modal) {
        closeReplyModal();
    }
});

// End of Support Ticket Functions

// Analytics Functions
async function loadAnalyticsData() {
    console.log('Loading analytics data...');
    
    // Get selected time range
    const timeRange = document.getElementById('timeRangeSelect')?.value || '1d';
    
    try {
        // Try main analytics endpoint first with time range parameter
        let response = await fetch(`/admin/api/analytics/summary?time_range=${timeRange}`);
        
        // If authentication fails (302 redirect) and we're on localhost, try test endpoint
        if (response.status === 302 && window.location.hostname === 'localhost') {
            console.log('Auth required, trying test endpoint for development...');
            response = await fetch(`/admin/api/analytics/test?time_range=${timeRange}`);
        }
        
        if (response.ok) {
            const data = await response.json();
            console.log('Analytics data loaded:', data);
            populateAnalytics(data);
            updateLabelsForTimeRange(timeRange);
        } else {
            console.error('Failed to load analytics:', response.status);
            const errorText = await response.text();
            console.error('Error response:', errorText);
            showAnalyticsError('Failed to load analytics data');
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
        showAnalyticsError('Error loading analytics data');
    }
}

function changeTimeRange() {
    console.log('Time range changed');
    // Save selected time range to localStorage
    const timeRange = document.getElementById('timeRangeSelect').value;
    localStorage.setItem('adminAnalyticsTimeRange', timeRange);
    // Reload analytics data with new time range
    loadAnalyticsData();
}

function updateLabelsForTimeRange(timeRange) {
    // Map time range to display text
    const timeRangeLabels = {
        '1d': '24h',
        '7d': '7d',
        '14d': '14d',
        '30d': '30d',
        '60d': '60d'
    };
    
    const label = timeRangeLabels[timeRange] || '24h';
    
    // Update operation labels
    const readsLabel = document.querySelector('#dailyReads')?.parentElement?.querySelector('.op-label');
    const writesLabel = document.querySelector('#dailyWrites')?.parentElement?.querySelector('.op-label');
    
    if (readsLabel) readsLabel.textContent = `Reads (${label})`;
    if (writesLabel) writesLabel.textContent = `Writes (${label})`;
    
    // Update deck activity label if showing 7 days specifically
    const deckActivityHeader = document.querySelector('.analytics-card .card-header h4');
    if (deckActivityHeader && deckActivityHeader.textContent.includes('Deck Activity')) {
        deckActivityHeader.textContent = `Deck Activity (${label})`;
    }
}

function populateAnalytics(data) {
    try {
        // Update timestamp
        const timestamp = new Date(data.timestamp).toLocaleString();
        document.getElementById('analyticsTimestamp').textContent = timestamp;
        
        // Show development indicator if using test data
        const environmentBadge = document.getElementById('analyticsEnvironment');
        if (data.environment === 'localhost-test' || window.location.hostname === 'localhost') {
            environmentBadge.style.display = 'inline';
            environmentBadge.textContent = 'Development Data';
            environmentBadge.className = 'badge badge-warning';
        } else {
            environmentBadge.style.display = 'none';
        }
        
        // Cost Analytics
        const costData = data.cost_analytics || {};
        document.getElementById('dailyCost').textContent = `$${(costData.daily_cost || 0).toFixed(4)}`;
        document.getElementById('monthlyProjection').textContent = `$${(costData.monthly_projection || 0).toFixed(2)}`;
        document.getElementById('costTrend').textContent = (costData.cost_trend || 'stable').charAt(0).toUpperCase() + (costData.cost_trend || 'stable').slice(1);
        
        // Update cost progress bar and styling
        const costPercent = costData.cost_threshold_percent || 0;
        const progressBar = document.getElementById('costProgressBar');
        const costAmount = document.getElementById('dailyCost');
        
        progressBar.style.width = Math.min(costPercent, 100) + '%';
        
        // Remove existing classes
        progressBar.classList.remove('warning', 'danger');
        costAmount.classList.remove('warning', 'danger');
        
        // Add appropriate styling based on cost threshold
        if (costPercent > 80) {
            progressBar.classList.add('danger');
            costAmount.classList.add('danger');
        } else if (costPercent > 60) {
            progressBar.classList.add('warning');
            costAmount.classList.add('warning');
        }
        
        // Database Operations
        document.getElementById('dailyReads').textContent = (costData.daily_reads || 0).toLocaleString();
        document.getElementById('dailyWrites').textContent = (costData.daily_writes || 0).toLocaleString();
        
        // User Analytics
        const userdata = data.user_analytics || {};
        document.getElementById('dailyActiveUsers').textContent = userdata.daily_active || 0;
        document.getElementById('weeklyActiveUsers').textContent = userdata.weekly_active || 0;
        document.getElementById('monthlyActiveUsers').textContent = userdata.monthly_active || 0;
        document.getElementById('totalUsers').textContent = userdata.total_users || 0;
        document.getElementById('newUsers7d').textContent = userdata.new_users_7d || 0;
        document.getElementById('retentionRate').textContent = `${userdata.retention_rate || 0}%`;
        
        // App Usage
        const appData = data.app_usage || {};
        document.getElementById('decksCreated7d').textContent = appData.decks_created_7d || 0;
        document.getElementById('publicDecks7d').textContent = appData.public_decks_7d || 0;
        document.getElementById('privateDecks7d').textContent = appData.private_decks_7d || 0;
        
        // Top Endpoints
        populateTopEndpoints(appData.top_endpoints || []);
        
        // Performance Analytics
        const perfData = data.performance_analytics || {};
        const avgTime = perfData.avg_response_time || 0;
        const p95Time = perfData.p95_response_time || 0;
        
        document.getElementById('avgResponseTime').textContent = `${avgTime.toFixed(0)}ms`;
        document.getElementById('p95ResponseTime').textContent = `${p95Time.toFixed(0)}ms`;
        document.getElementById('cacheHitRate').textContent = `${(perfData.cache_hit_rate || 0).toFixed(1)}%`;
        document.getElementById('activeAlerts').textContent = perfData.active_alerts || 0;
        document.getElementById('totalRequests').textContent = (appData.total_requests || 0).toLocaleString();
        
    } catch (error) {
        console.error('Error populating analytics:', error);
        showAnalyticsError('Error displaying analytics data');
    }
}

function populateTopEndpoints(endpoints) {
    const container = document.getElementById('topEndpoints');
    
    if (!endpoints || endpoints.length === 0) {
        container.innerHTML = '<div class="loading-text">No endpoint data available</div>';
        return;
    }
    
    const html = endpoints.map(([endpoint, count]) => `
        <div class="endpoint-item">
            <div class="endpoint-name">${endpoint}</div>
            <div class="endpoint-count">${count.toLocaleString()}</div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function showAnalyticsError(message) {
    const elements = [
        'dailyCost', 'monthlyProjection', 'costTrend', 'dailyReads', 'dailyWrites',
        'dailyActiveUsers', 'weeklyActiveUsers', 'monthlyActiveUsers', 'totalUsers',
        'newUsers7d', 'retentionRate', 'decksCreated7d', 'publicDecks7d', 'privateDecks7d',
        'avgResponseTime', 'p95ResponseTime', 'cacheHitRate', 'activeAlerts', 'totalRequests'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = 'Error';
            element.style.color = '#dc3545';
        }
    });
    
    document.getElementById('topEndpoints').innerHTML = `<div class="loading-text" style="color: #dc3545;">${message}</div>`;
    document.getElementById('analyticsTimestamp').textContent = 'Error loading data';
}

async function refreshAnalytics() {
    const refreshBtn = document.querySelector('button[onclick="refreshAnalytics()"]');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    try {
        await loadAnalyticsData();
    } finally {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

// Metrics Functions
async function loadMetricsData() {
    const performanceContainer = document.getElementById('performanceMetrics');
    const firestoreContainer = document.getElementById('firestoreMetrics');
    
    performanceContainer.innerHTML = '<div class="text-center" style="padding: 2rem; color: #6c757d;"><i class="fas fa-spinner fa-spin"></i> Loading metrics...</div>';
    firestoreContainer.innerHTML = '<div class="text-center" style="padding: 2rem; color: #6c757d;"><i class="fas fa-spinner fa-spin"></i> Loading database metrics...</div>';
    
    try {
        const response = await fetch('/admin/api/metrics/summary');
        if (response.ok) {
            const data = await response.json();
            displayPerformanceMetrics(data);
            displayFirestoreMetrics(data);
        } else {
            throw new Error('Failed to load metrics');
        }
    } catch (error) {
        performanceContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error loading metrics</div>';
        firestoreContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error loading database metrics</div>';
    }
}

function displayPerformanceMetrics(data) {
    const container = document.getElementById('performanceMetrics');
    const perf = data.performance || {};
    const responseTimes = perf.response_times || {};
    
    container.innerHTML = `
        <div class="metrics-grid">
            <div class="metric-item">
                <div class="metric-label">Average Response Time</div>
                <div class="metric-value">${responseTimes.average ? responseTimes.average.toFixed(2) : '0'} ms</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">95th Percentile</div>
                <div class="metric-value">${responseTimes.p95 ? responseTimes.p95.toFixed(2) : '0'} ms</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Active Users</div>
                <div class="metric-value">${perf.active_users || 0}</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Total Requests</div>
                <div class="metric-value">${perf.total_requests || 0}</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Cache Hit Rate</div>
                <div class="metric-value">${data.cache_hit_rate ? (data.cache_hit_rate * 100).toFixed(1) : '0'}%</div>
            </div>
        </div>
        
        <h6 class="mt-3">Top Endpoints</h6>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Endpoint</th>
                    <th>Requests</th>
                    <th>Avg Time</th>
                </tr>
            </thead>
            <tbody>
                ${perf.top_endpoints ? perf.top_endpoints.map(ep => `
                    <tr>
                        <td>${ep.endpoint}</td>
                        <td>${ep.count}</td>
                        <td>${ep.avg_time ? ep.avg_time.toFixed(2) : '0'} ms</td>
                    </tr>
                `).join('') : '<tr><td colspan="3">No endpoint data available</td></tr>'}
            </tbody>
        </table>
    `;
}

function displayFirestoreMetrics(data) {
    const container = document.getElementById('firestoreMetrics');
    const usage = data.firestore_usage || {};
    
    container.innerHTML = `
        <div class="metrics-grid">
            <div class="metric-item">
                <div class="metric-label">Total Reads (24h)</div>
                <div class="metric-value">${usage.reads_24h || 0}</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Total Writes (24h)</div>
                <div class="metric-value">${usage.writes_24h || 0}</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Total Deletes (24h)</div>
                <div class="metric-value">${usage.deletes_24h || 0}</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Estimated Cost</div>
                <div class="metric-value">$${usage.estimated_cost || '0.00'}</div>
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i> 
            For detailed Firestore usage statistics, visit <a href="/internal/firestore-usage" target="_blank">Firestore Usage Dashboard</a>
        </div>
    `;
}


// Add CSS for tickets and metrics
const style = document.createElement('style');
style.textContent = `
    .ticket-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: box-shadow 0.3s ease;
    }
    .ticket-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .ticket-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }
    .ticket-meta {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .ticket-subject {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-color);
    }
    .ticket-message {
        background: rgba(0, 0, 0, 0.03);
        padding: 1rem;
        border-radius: 0.25rem;
        margin: 1rem 0;
        white-space: pre-wrap;
        color: var(--text-color);
        max-height: 200px;
        overflow-y: auto;
    }
    .ticket-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    .ticket-info-item {
        font-size: 0.9rem;
    }
    .ticket-info-label {
        font-weight: 600;
        color: #6c757d;
    }
    .ticket-actions {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    /* Analytics Dashboard Styles */
    .analytics-section {
        margin-bottom: 2.5rem;
    }
    
    .section-title {
        color: var(--text-color);
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .analytics-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.3s ease, transform 0.2s ease;
    }
    
    .analytics-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .analytics-card .card-header {
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), rgba(25, 135, 84, 0.08));
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .analytics-card .card-header h4 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
    }
    
    .analytics-card .card-body {
        padding: 1.25rem;
    }
    
    /* Time range selector in card header */
    .time-range-select {
        padding: 0.3rem 2.2rem 0.3rem 0.7rem;
        font-size: 0.85rem;
        background: transparent;
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 0.375rem;
        color: var(--text-color);
        cursor: pointer;
        outline: none;
        width: auto;
        height: auto;
        line-height: 1.2;
        transition: all 0.2s ease;
        
        /* Custom dropdown arrow */
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='none' stroke='%230d6efd' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='4 6 8 10 12 6'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1em;
    }
    
    .time-range-select:hover {
        border-color: rgba(13, 110, 253, 0.4);
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    .time-range-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.15);
    }
    
    /* Dark mode support */
    [data-theme="dark"] .time-range-select {
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='none' stroke='%234dabf7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='4 6 8 10 12 6'%3e%3c/polyline%3e%3c/svg%3e");
    }
    
    /* Cost Analytics Styles */
    .cost-display {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .cost-amount {
        font-size: 2.5rem;
        font-weight: 700;
        color: #198754;
        margin-bottom: 0.5rem;
    }
    
    .cost-amount.warning {
        color: #ffc107;
    }
    
    .cost-amount.danger {
        color: #dc3545;
    }
    
    .cost-progress {
        margin: 1rem 0;
    }
    
    .progress {
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #198754, #20c997);
        transition: width 0.3s ease;
    }
    
    .progress-bar.warning {
        background: linear-gradient(90deg, #ffc107, #ffca2c);
    }
    
    .progress-bar.danger {
        background: linear-gradient(90deg, #dc3545, #e85d75);
    }
    
    .progress-label {
        font-size: 0.875rem;
        color: #6c757d;
        text-align: center;
    }
    
    .cost-details {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .detail-item, .growth-item, .health-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .detail-item:last-child, .growth-item:last-child, .health-item:last-child {
        border-bottom: none;
    }
    
    .detail-item .label, .growth-item .label, .health-item .label {
        font-weight: 500;
        color: #6c757d;
    }
    
    .detail-item .value, .growth-item .value, .health-item .value {
        font-weight: 600;
        color: var(--text-color);
    }
    
    /* Operations Grid - Improved centering */
    .operations-grid {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2rem;
        padding: 1rem;
    }
    
    .user-stats-grid, .deck-stats, .perf-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1rem;
        text-align: center;
    }
    
    .operation-item {
        flex: 0 1 150px;
        padding: 1.5rem 1rem;
        border-radius: 0.75rem;
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), rgba(13, 110, 253, 0.03));
        border: 1px solid rgba(13, 110, 253, 0.15);
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .operation-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
    }
    
    .user-stat, .deck-stat, .perf-stat {
        padding: 1rem 0.5rem;
        border-radius: 0.5rem;
        background: rgba(13, 110, 253, 0.05);
        border: 1px solid rgba(13, 110, 253, 0.1);
    }
    
    .op-icon {
        font-size: 1.25rem;
        color: #0d6efd;
        margin-bottom: 0.5rem;
    }
    
    .op-value, .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }
    
    .op-label, .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    /* Growth Stats */
    .growth-stats, .health-stats {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    /* Endpoints List */
    .endpoints-list {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .endpoint-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .endpoint-item:last-child {
        border-bottom: none;
    }
    
    .endpoint-name {
        font-family: monospace;
        font-size: 0.875rem;
        color: var(--text-color);
        flex: 1;
    }
    
    .endpoint-count {
        font-weight: 600;
        color: #0d6efd;
        background: rgba(13, 110, 253, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }
    
    .loading-text {
        text-align: center;
        color: #6c757d;
        padding: 2rem;
        font-style: italic;
    }
    
    .analytics-footer {
        text-align: center;
        padding: 1rem 0;
        border-top: 1px solid var(--border-color);
        margin-top: 2rem;
    }
    
    .badge {
        display: inline-block;
        padding: 0.25em 0.5em;
        font-size: 0.75em;
        font-weight: 600;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }
    
    .badge-warning {
        color: #212529;
        background-color: #ffc107;
    }
    
    .badge-info {
        color: #ffffff;
        background-color: #0dcaf0;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .analytics-grid {
            grid-template-columns: 1fr;
        }
        
        .operations-grid {
            flex-direction: column;
            gap: 1rem;
        }
        
        .operation-item {
            flex: 1 1 100%;
            width: 100%;
            max-width: 250px;
        }
        
        .user-stats-grid, .deck-stats, .perf-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .cost-amount {
            font-size: 2rem;
        }
    }
    .metric-item {
        text-align: center;
    }
    .metric-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--text-color);
    }
    .status-new {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .status-in_progress {
        background-color: #fff3cd;
        color: #856404;
    }
    .status-resolved {
        background-color: #d4edda;
        color: #155724;
    }
    .status-closed {
        background-color: #e2e3e5;
        color: #383d41;
    }
    [data-theme="dark"] .ticket-message {
        background: rgba(255, 255, 255, 0.05);
    }
    [data-theme="dark"] .status-new {
        background-color: #0c5460;
        color: #d1ecf1;
    }
    [data-theme="dark"] .status-in_progress {
        background-color: #856404;
        color: #fff3cd;
    }
    [data-theme="dark"] .status-resolved {
        background-color: #155724;
        color: #d4edda;
    }
    [data-theme="dark"] .status-closed {
        background-color: #383d41;
        color: #e2e3e5;
    }
    
    /* Ticket filters and enhanced ticket styling */
    .ticket-filters {
        padding: 1rem 0;
    }
    
    .ticket-card-enhanced {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: box-shadow 0.3s ease, border-color 0.3s ease;
        position: relative;
    }
    
    .ticket-card-enhanced:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #0d6efd;
    }
    
    .ticket-card-enhanced.priority-new {
        border-left: 4px solid #dc3545;
    }
    
    .ticket-card-enhanced.priority-in-progress {
        border-left: 4px solid #ffc107;
    }
    
    .ticket-reply-section {
        background: rgba(0, 0, 0, 0.03);
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
        border: 1px dashed var(--border-color);
    }
    
    [data-theme="dark"] .ticket-reply-section {
        background: rgba(255, 255, 255, 0.05);
    }
    
    .ticket-reply-form {
        margin-top: 0.75rem;
    }
    
    .ticket-reply-toggle {
        cursor: pointer;
        user-select: none;
        padding: 0.5rem 0;
        color: #0d6efd;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .ticket-reply-toggle:hover {
        color: #0b5ed7;
        text-decoration: underline;
    }
    
    .ticket-original-content {
        background: rgba(13, 110, 253, 0.05);
        border-left: 3px solid #0d6efd;
        padding: 1rem;
        margin: 0.75rem 0;
        border-radius: 0.25rem;
        font-size: 0.9rem;
    }
    
    [data-theme="dark"] .ticket-original-content {
        background: rgba(13, 110, 253, 0.15);
    }
    
    .chevron-rotate {
        transform: rotate(90deg);
        transition: transform 0.2s ease;
    }
    
    .badge-danger {
        background-color: #dc3545 !important;
        color: white !important;
    }
    
    .badge-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }
    
    .badge-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
    
    .form-select-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    /* Admin Reply Section Styling */
    .admin-reply-section {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.08), rgba(13, 110, 253, 0.08));
        border: 1px solid rgba(25, 135, 84, 0.2);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .admin-reply-header {
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(25, 135, 84, 0.2);
    }
    
    .admin-reply-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #198754;
        margin: 0;
    }
    
    .admin-reply-meta {
        font-size: 0.8rem;
    }
    
    .admin-reply-content {
        background: var(--card-bg);
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid var(--border-color);
        white-space: pre-wrap;
        color: var(--text-color);
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .email-status-success {
        margin-top: 0.5rem;
        color: #198754;
    }
    
    .email-status-error {
        margin-top: 0.5rem;
        color: #ffc107;
    }
    
    [data-theme="dark"] .admin-reply-section {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.15), rgba(13, 110, 253, 0.15));
        border-color: rgba(25, 135, 84, 0.3);
    }
    
    [data-theme="dark"] .admin-reply-header {
        border-bottom-color: rgba(25, 135, 84, 0.3);
    }
`;
document.head.appendChild(style);

// Tooltip functionality
function initializeTooltips() {
    // Create tooltip element
    let tooltip = document.querySelector('.custom-tooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.className = 'custom-tooltip';
        document.body.appendChild(tooltip);
    }
    
    // Add event listeners to all ticket titles
    document.addEventListener('mouseover', function(e) {
        if (e.target.classList.contains('ticket-title') && e.target.dataset.tooltip) {
            tooltip.textContent = e.target.dataset.tooltip;
            tooltip.style.display = 'block';
        }
    });
    
    document.addEventListener('mousemove', function(e) {
        if (tooltip.style.display === 'block') {
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY - tooltip.offsetHeight - 10) + 'px';
        }
    });
    
    document.addEventListener('mouseout', function(e) {
        if (e.target.classList.contains('ticket-title')) {
            tooltip.style.display = 'none';
        }
    });
}

// Initialize tooltips when tickets are loaded
const originalLoadSupportTickets = loadSupportTickets;
loadSupportTickets = async function() {
    await originalLoadSupportTickets.apply(this, arguments);
    initializeTooltips();
};

// Initialize tooltips on page load
document.addEventListener('DOMContentLoaded', initializeTooltips);


async function loadDatabaseUsage() {
    try {
        // Skip API call since we now have analytics dashboard with better data
        // and this endpoint requires special authentication
        
        // Set placeholder values instead of making failed API calls
        const dbReadsEl = document.getElementById('dbReads');
        const dbWritesEl = document.getElementById('dbWrites');
        if (dbReadsEl) dbReadsEl.textContent = 'See Analytics';
        if (dbWritesEl) dbWritesEl.textContent = 'See Analytics';
    } catch (error) {
        console.error('Failed to load database usage:', error);
        const dbReadsEl = document.getElementById('dbReads');
        const dbWritesEl = document.getElementById('dbWrites');
        if (dbReadsEl) dbReadsEl.textContent = 'Error';
        if (dbWritesEl) dbWritesEl.textContent = 'Error';
    }
}


</script>
{% endblock %}