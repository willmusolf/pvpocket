<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ deck.name }} - Deck Export</title>
    <style>
        :root {
            /* Dark theme variables */
            --bg-color: #2d3436;
            --container-bg: #34495e;
            --text-color: #ddd;
            --title-color: #ecf0f1;
            --border-color: #5a6c7d;
            --grid-bg: #2c3e50;
            --card-bg: #34495e;
            --card-border: #5a6c7d;
            --empty-card-bg: #2c3e50;
            --empty-card-border: #7f8c8d;
            --description-color: #bdc3c7;
            --button-bg: #7f8c8d;
            --button-primary: #3498db;
            --button-text: #ecf0f1;
        }
        
        body.light-theme {
            /* Light theme variables */
            --bg-color: #f5f5f5;
            --container-bg: #ffffff;
            --text-color: #333;
            --title-color: #333;
            --border-color: #e0e0e0;
            --grid-bg: #fafafa;
            --card-bg: #fff;
            --card-border: #ddd;
            --empty-card-bg: #f8f8f8;
            --empty-card-border: #ccc;
            --description-color: #666;
            --button-bg: #495057;
            --button-primary: #007bff;
            --button-text: #fff;
        }

        body {
            margin: 0;
            padding: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            height: auto;
            color: var(--text-color);
        }
        
        .export-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-height: fit-content;
            overflow: visible;
        }
        
        .deck-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        .deck-title {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--title-color);
            margin: 0 0 8px 0;
        }
        
        .deck-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        
        .deck-creator {
            text-align: center;
            color: var(--description-color);
            font-size: 0.85em;
            margin: 8px 0;
        }
        
        .deck-description {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--description-color);
            font-size: 0.9em;
            line-height: 1.4;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            word-break: break-word;
            text-align: left;
            padding: 15px 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .deck-types {
            display: flex;
            gap: 8px;
        }
        
        .energy-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
        }
        
        .card-count {
            background: #95a5a6;
            color: #2c3e50;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.8em;
        }
        
        .cards-container {
            margin: 15px auto;
            padding: 8px; /* Consistent padding matching 2x10 layout */
            background: var(--grid-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: visible;
            display: flex;
            justify-content: center;
            align-items: center;
            width: fit-content;
            max-width: calc(100% - 40px); /* More conservative to prevent mobile overflow */
            /* Isolate reflows to prevent layout thrashing */
            contain: layout style;
        }
        
        /* Disable transitions during programmatic resizing */
        .cards-container.resizing,
        .cards-container.resizing .card-slot,
        .cards-container.resizing .cards-grid {
            transition: none !important;
        }
        
        /* Special scrolling behavior for 2x10 layout only - dynamic based on screen size */
        .cards-container.layout-2x10-container {
            overflow-x: hidden; /* Default to hidden, will be set by JS based on screen size */
            overflow-y: visible; /* Allow content to show by default, JS will adjust if needed */
            max-width: calc(100% - 40px); /* Fit within export container with padding */
            width: calc(100% - 40px); /* Take full available width */
            margin: 15px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            box-sizing: border-box;
        }
        
        /* Ensure the grid inside scrollable container has proper spacing */
        .cards-container.layout-2x10-container .cards-grid {
            margin: 0;
            min-width: fit-content;
            flex-shrink: 0;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(4, auto);
            grid-template-rows: repeat(5, auto);
            gap: 8px;
            justify-items: center;
            align-items: center;
            width: fit-content;
        }
        
        .cards-grid.layout-2x10 {
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            width: fit-content;
        }
        
        .cards-grid.layout-5x4 {
            grid-template-columns: repeat(4, auto);
            grid-template-rows: repeat(5, auto);
            gap: 8px; /* Consistent gap */
            width: fit-content;
        }
        
        .card-slot {
            aspect-ratio: 63/88;
            border-radius: 3.5%;
            overflow: hidden;
            position: relative;
            background: var(--card-bg);
            border: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            width: 140px;
            flex-shrink: 0;
        }
        
        .card-slot.empty {
            background: var(--empty-card-bg);
            border: 2px dashed var(--empty-card-border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            opacity: 0.8;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .empty-slot-text {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.5;
        }
        
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border-radius: 3.5%;
            /* Prevent visual jumps during resizing and loading */
            will-change: transform;
            /* Ensure consistent sizing during load */
            min-width: 100%;
            min-height: 100%;
        }
        
        /* Export-specific card image styling for better fit */
        .is-export-clone .card-image {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            display: block !important;
            border-radius: 3.5% !important;
        }
        
        
        .section-divider {
            grid-column: 1 / -1;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ddd, transparent);
            margin: 10px 0;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 1600px;
            margin: 0 auto 25px auto;
        }
        
        .toggle-section {
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-label {
            font-size: 0.9em;
            color: var(--text-color);
        }
        
        .toggle-button {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .toggle-button.active {
            background: var(--button-primary);
        }
        
        .export-button {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .export-button.primary {
            background: var(--button-primary);
        }
        
        .export-button:disabled {
            background: #5a6c7d;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Ensure close button is visible in light theme */
        body.light-theme .export-button {
            color: var(--button-text);
        }
        
        /* Make close button more visible in light theme */
        body.light-theme .export-button:not(.primary) {
            color: #333 !important;
            background: #e9ecef !important;
        }

        /* Styles for the cloned element during export */
        .is-export-clone {
            position: absolute !important;
            left: -9999px !important; /* Move off-screen but keep renderable */
            top: 0 !important;
            visibility: visible !important;
            box-shadow: none !important;
            max-width: none !important;
            /* Override all responsive behaviors */
            width: auto !important;
            height: auto !important;
            overflow: visible !important;
            transform: none !important;
            /* Ensure consistent rendering regardless of viewport */
            min-width: 0 !important;
            min-height: 0 !important;
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
            /* Debug: temporarily visible to check styling */
            /* left: 50px !important; */
            /* top: 50px !important; */
            /* z-index: 10000 !important; */
        }

        /* Base styles for any export - override all responsive CSS */
        .is-export-clone,
        .is-export-clone .cards-container,
        .is-export-clone .cards-grid {
            width: fit-content !important;
            margin-left: auto !important;
            margin-right: auto !important;
            /* Force disable all responsive behavior */
            max-width: none !important;
            min-width: 0 !important;
            overflow: visible !important;
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
        }

        /* Override all responsive card sizing for export */
        .is-export-clone .card-slot {
            width: 110px !important;
            height: 154px !important; /* Maintain 63/88 aspect ratio: 110 * (88/63) = 153.65 ≈ 154 */
            max-width: 110px !important;
            min-width: 110px !important;
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
            padding: 4px !important; /* Add padding for better image fit */
        }

        /* Override all responsive container behavior for export */
        .is-export-clone .cards-container {
            padding: 8px !important;
            margin: 15px auto !important;
            overflow: visible !important;
            max-width: none !important;
            width: fit-content !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            /* Disable all scrolling behaviors */
            overflow-x: visible !important;
            overflow-y: visible !important;
        }

        /* Override all responsive grid behavior for export */
        .is-export-clone .cards-grid {
            gap: 8px !important;
            width: fit-content !important;
            max-width: none !important;
            min-width: 0 !important;
            margin: 0 !important;
            overflow: visible !important;
            flex-shrink: 0 !important;
        }

        /* Override ALL media queries for export clones */
        @media (max-width: 1300px) {
            .is-export-clone,
            .is-export-clone .cards-container,
            .is-export-clone .cards-grid,
            .is-export-clone .card-slot {
                /* Force maintain export dimensions regardless of screen size */
                max-width: none !important;
                min-width: initial !important;
                width: auto !important;
                padding: initial !important;
                margin: initial !important;
                overflow: visible !important;
            }
        }

        @media (max-width: 1000px) {
            .is-export-clone,
            .is-export-clone .cards-container,
            .is-export-clone .cards-grid,
            .is-export-clone .card-slot {
                /* Force maintain export dimensions regardless of screen size */
                max-width: none !important;
                min-width: initial !important;
                width: auto !important;
                padding: initial !important;
                margin: initial !important;
                overflow: visible !important;
            }
        }

        @media (max-width: 800px) {
            .is-export-clone,
            .is-export-clone .cards-container,
            .is-export-clone .cards-grid,
            .is-export-clone .card-slot {
                /* Force maintain export dimensions regardless of screen size */
                max-width: none !important;
                min-width: initial !important;
                width: auto !important;
                padding: initial !important;
                margin: initial !important;
                overflow: visible !important;
            }
            
            .is-export-clone .cards-grid.layout-5x4 .card-slot {
                /* Prevent mobile card resizing during export */
                width: 110px !important;
                max-width: 110px !important;
            }
        }

        @media (max-width: 600px) {
            .is-export-clone,
            .is-export-clone .cards-container,
            .is-export-clone .cards-grid,
            .is-export-clone .card-slot {
                /* Force maintain export dimensions regardless of screen size */
                max-width: none !important;
                min-width: initial !important;
                width: auto !important;
                padding: initial !important;
                margin: initial !important;
                overflow: visible !important;
            }
            
            .is-export-clone .cards-grid.layout-5x4 .card-slot {
                /* Prevent mobile card resizing during export */
                width: 110px !important;
                max-width: 110px !important;
            }
        }

        /* --- 5x4 Export Prep --- */
        .is-export-clone.export-prep-5x4 {
            width: 488px !important; /* Reduced for tighter fit */
            padding: 10px !important; /* Reduced padding for tighter fit */
            /* Force override all responsive behaviors */
            max-width: none !important;
            min-width: 488px !important;
            overflow: visible !important;
            box-sizing: border-box !important;
        }
        .is-export-clone.export-prep-5x4 .cards-container {
            padding: 6px !important; /* Reduced internal padding */
            width: 455px !important; /* 480px - 2*10px padding */
            max-width: none !important;
            min-width: 455px !important;
            overflow: visible !important;
            margin: 15px auto !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        .is-export-clone.export-prep-5x4 .cards-grid {
            display: grid !important;
            grid-template-columns: repeat(4, 105px) !important;
            grid-template-rows: repeat(5, auto) !important;
            row-gap: 6px !important; /* Even tighter vertical spacing */
            column-gap: 10px !important; /* Perfect horizontal spacing */
            width: 450px !important; /* 4*105px + 3*10px = 450px */
            max-width: none !important;
            min-width: 444px !important;
            overflow: visible !important;
            margin: 0 auto !important; /* Perfect centering */
        }

        /* --- 2x10 Export Prep --- */
        .is-export-clone.export-prep-2x10 {
            width: 1183px !important; /* Adjusted for 1163px container + 2*10px padding */
            padding: 10px !important; /* Reduced padding for tighter fit */
            /* Force override all responsive behaviors */
            max-width: none !important;
            min-width: 1196px !important;
            overflow: visible !important;
            box-sizing: border-box !important;
        }
        .is-export-clone.export-prep-2x10 .cards-container {
            padding: 5px !important; /* Even padding on all sides like 5x4 */
            width: 1163px !important; /* Keep original width for even appearance */
            max-width: none !important;
            min-width: 1163px !important;
            overflow: visible !important;
            margin: 15px auto !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        .is-export-clone.export-prep-2x10 .cards-grid {
            display: grid !important;
            grid-template-columns: repeat(10, 110.9px) !important; /* Added 2px total across all cards */
            grid-template-rows: repeat(2, auto) !important;
            gap: 6px !important; /* Tight spacing between cards */
            width: 1156px !important; /* 10*110.9px + 9*6px = 1156px */
            max-width: none !important;
            min-width: 1152px !important;
            overflow: visible !important;
            margin: 0 auto !important; /* Perfect centering */
        }
        
        /* Responsive design - containers adapt but layouts switch via JavaScript */
        @media (max-width: 1300px) {
            .export-container {
                max-width: 95%;
                margin: 0 auto;
                padding: clamp(12px, 2vw, 20px); /* Smooth padding transition */
            }
        }
        
        /* Intermediate breakpoint for smoother transitions */
        @media (max-width: 1000px) {
            .export-container {
                padding: clamp(10px, 1.8vw, 15px);
            }
        }
        
        /* Mobile breakpoint for very small screens */
        @media (max-width: 600px) {
            .export-container {
                padding: clamp(6px, 1.2vw, 10px);
            }
            
            .cards-container {
                padding: 8px; /* Consistent with 2x10 layout */
                margin: 15px auto; /* Consistent with 2x10 layout */
                max-width: calc(100% - 50px); /* More conservative on mobile */
            }
            
            /* Ensure 5x4 layout maintains consistent spacing on mobile - no scrolling */
            .cards-grid.layout-5x4 {
                gap: 6px; /* Tighter gap on mobile for better fit */
            }
            
            /* 5x4 cards will be dynamically sized to always fit screen */
            .cards-grid.layout-5x4 .card-slot {
                /* Dynamic sizing handled by applyDynamicSizing5x4() */
                width: 60px; /* Smaller minimum for mobile to always fit */
                max-width: 140px; /* Ensure reasonable maximum */
            }
        }
        
        @media (max-width: 800px) {
            .export-container {
                padding: clamp(8px, 1.5vw, 12px); /* Smooth transition instead of fixed 10px */
            }
            
            .cards-container {
                padding: 8px; /* Consistent padding matching 2x10 layout */
                margin: 15px auto; /* Consistent margin */
                max-width: calc(100% - 45px); /* More conservative on tablets */
            }
            
            .cards-grid {
                gap: 8px; /* Consistent gap for all layouts */
            }
            
            /* 5x4 cards will always fit screen - no scrolling */
            .cards-grid.layout-5x4 .card-slot {
                /* Dynamic sizing handled by applyDynamicSizing5x4() */
                width: 80px; /* Smaller default for tablets to ensure fit */
                max-width: 140px; /* Ensure reasonable maximum */
            }
            
            /* Mobile-specific improvements */
            .deck-description {
                font-size: 0.8em;
                line-height: 1.3;
                padding: 10px;
                margin-top: 15px;
                background: var(--card-bg);
                border-radius: 8px;
                border: 1px solid var(--border-color);
                text-align: left;
            }
            
            .deck-title {
                font-size: 1.5em;
            }
            
            .deck-creator {
                font-size: 0.8em;
            }
            
            .controls {
                padding: 10px;
                margin: 0 auto 15px auto;
            }
            
            .toggle-section {
                gap: 10px;
            }
            
            .toggle-button {
                padding: 8px 12px;
                font-size: 11px;
            }
            
            .export-button {
                padding: 10px 16px;
                font-size: 13px;
                margin: 0 4px;
            }
        }
        
        /* Auto-switch styles - these will be dynamically applied */
        .cards-grid.layout-5x4.auto-mobile {
            /* Applied when auto-switching to mobile for 5x4 layout */
            /* No max-width constraint - let container handle sizing */
        }
        
        .cards-grid.layout-2x10.auto-desktop {
            /* Applied when auto-switching to desktop for 2x10 layout */
            max-width: 1174px;
        }
        
        /* Download modal styles */
        .download-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        body.light-theme .download-modal {
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: var(--container-bg);
            color: var(--text-color);
            padding: 32px;
            border-radius: 16px;
            width: min(480px, 95vw);
            max-width: 95vw;
            max-height: 90vh;
            margin: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            overflow-y: auto;
        }
        
        .modal-title {
            color: var(--title-color);
            margin: 0 0 28px 0;
            font-size: 1.6em;
            font-weight: 700;
            text-align: center;
        }
        
        .modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .modal-section.full-width {
            grid-column: 1 / -1;
        }
        
        .modal-section {
            margin-bottom: 20px;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            min-height: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: hidden;
        }
        
        body.light-theme .modal-section {
            background: rgba(0, 0, 0, 0.02);
        }
        
        .modal-subtitle {
            color: var(--text-color);
            margin: 0 0 6px 0;
            font-size: 1em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            text-align: center;
            opacity: 0.9;
        }
        
        .modal-section.full-width .modal-subtitle {
            margin: 0 0 6px 0;
        }
        
        .modal-section.full-width {
            padding: 16px 20px;
        }
        
        .modal-button-group {
            display: flex;
            gap: 8px;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        
        .modal-option-btn {
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid transparent;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 80px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }
        
        .modal-option-btn:hover {
            background: var(--button-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .modal-option-btn.active {
            background: var(--button-primary);
            color: var(--button-text);
            border-color: var(--button-primary);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }
        
        
        .modal-toggle-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        
        .modal-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .modal-toggle:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .modal-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--button-primary);
            cursor: pointer;
            transition: none;
        }
        
        .modal-toggle input[type="checkbox"]:checked {
            accent-color: var(--button-primary);
        }
        
        .modal-toggle-label {
            color: var(--text-color);
            cursor: pointer;
        }
        
        .modal-toggle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .modal-toggle.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }
        
        .modal-toggle.disabled .modal-toggle-label {
            cursor: not-allowed;
            color: var(--description-color);
        }
        
        .modal-actions {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .modal-action-btn {
            flex: 1;
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 16px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .modal-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .modal-action-btn.primary {
            background: var(--button-primary);
            font-weight: 700;
        }
        
        .modal-action-btn.primary:hover {
            background: #4a90e2;
            box-shadow: 0 6px 16px rgba(74, 144, 226, 0.4);
        }
        
        .modal-action-btn:disabled {
            background: var(--button-bg);
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Tablet responsive */
        @media (max-width: 768px) {
            .modal-content {
                margin: 10px;
                padding: 12px;
                width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
                max-height: calc(100vh - 20px);
                border-radius: 6px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            }
            
            .modal-title {
                font-size: 1em;
                margin-bottom: 8px;
                font-weight: 600;
            }
            
            .modal-grid {
                grid-template-columns: 1fr;
                gap: 6px;
                margin-bottom: 8px;
            }
            
            .modal-section {
                padding: 6px 8px;
                margin-bottom: 5px;
                border-radius: 6px;
            }
            
            .modal-subtitle {
                font-size: 0.8em;
                margin-bottom: 4px;
                font-weight: 600;
                letter-spacing: 0.5px;
            }
            
            .modal-toggle-group {
                gap: 5px;
                flex-direction: column;
                align-items: stretch;
            }
            
            .modal-toggle {
                justify-content: center;
                padding: 4px 6px;
                font-size: 0.8em;
                border-radius: 4px;
            }
            
            .modal-toggle input[type="checkbox"] {
                width: 14px;
                height: 14px;
            }
            
            .modal-button-group {
                flex-direction: column;
                gap: 4px;
            }
            
            .modal-option-btn {
                width: 100%;
                padding: 8px 10px;
                font-size: 0.8em;
                min-height: 40px;
                height: 40px;
                border-radius: 6px;
                font-weight: 500;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .modal-actions {
                gap: 6px;
                margin-top: 8px;
                padding-top: 8px;
                flex-direction: column;
            }
            
            .modal-action-btn {
                width: 100%;
                padding: 10px;
                font-size: 0.85em;
                min-height: 40px;
                border-radius: 6px;
                font-weight: 600;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .modal-content {
                margin: 8px;
                padding: 8px;
                width: calc(100vw - 16px);
                max-width: calc(100vw - 16px);
                max-height: calc(100vh - 16px);
                border-radius: 4px;
                box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            }
            
            .modal-title {
                font-size: 0.9em;
                margin-bottom: 6px;
                font-weight: 600;
            }
            
            .modal-grid {
                gap: 4px;
                margin-bottom: 6px;
            }
            
            .modal-section {
                padding: 4px 6px;
                margin-bottom: 3px;
                border-radius: 4px;
            }
            
            .modal-subtitle {
                font-size: 0.75em;
                margin-bottom: 3px;
                font-weight: 600;
                letter-spacing: 0.3px;
            }
            
            .modal-toggle {
                padding: 3px 4px;
                font-size: 0.75em;
                border-radius: 3px;
            }
            
            .modal-toggle input[type="checkbox"] {
                width: 12px;
                height: 12px;
            }
            
            .modal-option-btn {
                padding: 6px 8px;
                font-size: 0.75em;
                min-height: 36px;
                height: 36px;
                border-radius: 4px;
                font-weight: 500;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .modal-actions {
                gap: 4px;
                margin-top: 6px;
                padding-top: 6px;
            }
            
            .modal-action-btn {
                padding: 8px;
                font-size: 0.8em;
                min-height: 36px;
                border-radius: 4px;
                font-weight: 600;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 360px) {
            .modal-content {
                margin: 5px;
                padding: 6px;
                width: calc(100vw - 10px);
                max-width: calc(100vw - 10px);
                max-height: calc(100vh - 10px);
                border-radius: 3px;
                box-shadow: 0 6px 15px rgba(0,0,0,0.6);
            }
            
            .modal-title {
                font-size: 0.85em;
                margin-bottom: 4px;
                font-weight: 600;
            }
            
            .modal-grid {
                gap: 3px;
                margin-bottom: 4px;
            }
            
            .modal-section {
                padding: 3px 4px;
                margin-bottom: 2px;
                border-radius: 3px;
            }
            
            .modal-subtitle {
                font-size: 0.7em;
                margin-bottom: 2px;
                font-weight: 600;
                letter-spacing: 0.2px;
            }
            
            .modal-toggle {
                padding: 2px 3px;
                font-size: 0.7em;
                border-radius: 2px;
            }
            
            .modal-toggle input[type="checkbox"] {
                width: 10px;
                height: 10px;
            }
            
            .modal-option-btn {
                padding: 5px 6px;
                font-size: 0.7em;
                min-height: 32px;
                height: 32px;
                border-radius: 3px;
                font-weight: 500;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .modal-actions {
                gap: 3px;
                margin-top: 4px;
                padding-top: 4px;
            }
            
            .modal-action-btn {
                padding: 6px;
                font-size: 0.75em;
                min-height: 32px;
                border-radius: 3px;
                font-weight: 600;
            }
        }
        
        /* Print styles for cleaner image output */
        @media print {
            body { background: var(--bg-color); padding: 0; }
            .controls { display: none; }
            .export-container { box-shadow: none; margin: 0; }
            .download-modal { display: none; }
        }
        
        /* 5x4 layout - always fit all cards on screen, no scrolling */
        .cards-grid.layout-5x4 {
            gap: 8px; /* Consistent gap with 2x10 layout */
            width: fit-content; /* Let JavaScript handle precise sizing */
            max-width: 100%; /* Ensure it never exceeds container */
        }

        .cards-grid.layout-5x4 .card-slot {
            /* Dynamic sizing will be handled by JavaScript */
            width: 140px; /* Default size, will be overridden by JS */
            flex-shrink: 0; /* Prevent cards from shrinking unexpectedly */
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="toggle-section">
            <div class="toggle-group">
                <span class="toggle-label">Layout:</span>
                <button class="toggle-button active" id="layout-auto" onclick="toggleLayout('auto')">
                    Auto
                </button>
                <button class="toggle-button" id="layout-2x10" onclick="toggleLayout('2x10')">
                    2×10
                </button>
                <button class="toggle-button" id="layout-5x4" onclick="toggleLayout('5x4')">
                    5×4
                </button>
            </div>
            <div class="toggle-group">
                <span class="toggle-label">Theme:</span>
                <button class="toggle-button active" id="theme-dark" onclick="toggleTheme('dark')">
                    Dark
                </button>
                <button class="toggle-button" id="theme-light" onclick="toggleTheme('light')">
                    Light
                </button>
            </div>
        </div>
        <button id="downloadBtn" class="export-button primary" onclick="showDownloadOptions()">
            📷 Download Image
        </button>
        <button id="cancelBtn" class="export-button" onclick="cancelDownload()" style="display: none; background-color: #e74c3c; color: white; margin-left: 10px;">
            ✖️ Cancel
        </button>
        
        <div id="downloadModal" class="download-modal" style="display: none;">
            <div class="modal-content">
                <h3 class="modal-title">Download Options</h3>
                
                <!-- Include section moved to top -->
                <div class="modal-section full-width">
                    <h4 class="modal-subtitle">Include</h4>
                    <div class="modal-toggle-group">
                        <label class="modal-toggle">
                            <input type="checkbox" id="modal-include-title" checked>
                            <span class="modal-toggle-label">Title & Info</span>
                        </label>
                        <label class="modal-toggle">
                            <input type="checkbox" id="modal-include-description" checked>
                            <span class="modal-toggle-label">Description</span>
                        </label>
                    </div>
                </div>
                
                <!-- Format and Theme side by side -->
                <div class="modal-grid">
                    <div class="modal-section">
                        <h4 class="modal-subtitle">Format</h4>
                        <div class="modal-button-group">
                            <button class="modal-option-btn" id="modal-format-2x10" onclick="selectModalFormat('2x10')">
                                2×10
                            </button>
                            <button class="modal-option-btn" id="modal-format-5x4" onclick="selectModalFormat('5x4')">
                                5×4
                            </button>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <h4 class="modal-subtitle">Theme</h4>
                        <div class="modal-button-group">
                            <button class="modal-option-btn" id="modal-theme-dark" onclick="selectModalTheme('dark')">
                                Dark
                            </button>
                            <button class="modal-option-btn" id="modal-theme-light" onclick="selectModalTheme('light')">
                                Light
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Quality section below -->
                <div class="modal-section">
                    <h4 class="modal-subtitle">Quality</h4>
                    <div class="modal-button-group">
                        <button class="modal-option-btn" id="modal-quality-standard" onclick="selectModalQuality('standard')">
                            Standard
                        </button>
                        <button class="modal-option-btn" id="modal-quality-high" onclick="selectModalQuality('high')">
                            High
                        </button>
                        <button class="modal-option-btn" id="modal-quality-ultra" onclick="selectModalQuality('ultra')">
                            Ultra
                        </button>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="modal-action-btn primary" id="modal-download-btn" onclick="downloadWithSelectedOptions()" disabled>
                        📷 Download
                    </button>
                    <button class="modal-action-btn" onclick="hideDownloadOptions()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="export-container" id="deck-export">
        <div class="deck-header">
            <h1 class="deck-title">{{ deck.name }}</h1>
            {% if owner_info %}
            <div class="deck-creator">
                Created by {{ owner_info.username }} on pvpocket.xyz
            </div>
            {% endif %}
            <div class="deck-info">
                {% if deck_types %}
                <div class="deck-types">
                    {% for deck_type in deck_types %}
                    {% set energy_url = config.ENERGY_ICON_URLS.get(deck_type) %}
                    {% if energy_url and ('storage.googleapis.com' in energy_url or 'firebasestorage.googleapis.com' in energy_url) %}
                        {% set energy_proxy_url = '/api/proxy-image?url=' + energy_url|urlencode %}
                    {% else %}
                        {% set energy_proxy_url = energy_url %}
                    {% endif %}
                    <img src="{{ energy_proxy_url }}" 
                         alt="{{ deck_type }}" 
                         class="energy-badge"
                         title="{{ deck_type }}"
                         data-original-src="{{ energy_url }}"
                         crossorigin="anonymous">
                    {% endfor %}
                </div>
                {% endif %}
                <div class="card-count">{{ ordered_cards|length - ordered_cards.count(None) }}/20 Cards</div>
            </div>
        </div>
        
        <div class="cards-container">
            <div class="cards-grid" id="cards-grid">
                {% for card in ordered_cards %}
                    {% if card %}
                        <div class="card-slot">
                            {% set image_url = card.display_image_path or card.firebase_image_url %}
                            {% if image_url and ('storage.googleapis.com' in image_url or 'firebasestorage.googleapis.com' in image_url) %}
                                {% set proxy_url = '/api/proxy-image?url=' + image_url|urlencode %}
                            {% else %}
                                {% set proxy_url = image_url or 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBoZWlnaHQ9IjE1NCIgdmlld0JveD0iMCAwIDExMCAxNTQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iMCIgeTE9IjAiIHgyPSIxIiB5Mj0iMCI+PHN0b3Agc3RvcC1jb2xvcj0iIzM0NDk1ZSIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzJjM2U1MCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMTAiIGhlaWdodD0iMTU0IiBmaWxsPSJ1cmwoI2EpIiByeD0iNiIvPjx0ZXh0IHg9IjU1IiB5PSI3NyIgZmlsbD0iIzk1YTVhNiIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkNhcmQ8L3RleHQ+PC9zdmc+' %}
                            {% endif %}
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBoZWlnaHQ9IjE1NCIgdmlld0JveD0iMCAwIDExMCAxNTQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iMCIgeTE9IjAiIHgyPSIxIiB5Mj0iMCI+PHN0b3Agc3RvcC1jb2xvcj0iIzM0NDk1ZSIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzJjM2U1MCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMTAiIGhlaWdodD0iMTU0IiBmaWxsPSJ1cmwoI2EpIiByeD0iNiIvPjx0ZXh0IHg9IjU1IiB5PSI3NyIgZmlsbD0iIzk1YTVhNiIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkxvYWRpbmcuLi48L3RleHQ+PC9zdmc+" 
                                 alt="{{ card.name }}" 
                                 class="card-image"
                                 title="{{ card.name }}"
                                 data-fallback-src="{{ proxy_url }}"
                                 data-original-src="{{ image_url }}"
                                 crossorigin="anonymous"
                                 onerror="handleImageError(this)"
                                 style="width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 3.5%;">
                        </div>
                    {% else %}
                        <div class="card-slot empty">
                            <div class="empty-slot-text">EMPTY</div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        {% if deck.description and deck.description.strip() %}
        <div class="deck-description">
            <strong>Description:</strong> {{ deck.description|e }}
        </div>
        {% endif %}
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="console.error('html2canvas failed to load from CDN')"></script>
    <script>
        // Initialize with html2canvas directly (no dom-to-image CDN attempts)
        (function() {
            console.log('Initializing html2canvas export system...');
            
            // Check if html2canvas is available
            setTimeout(() => {
                if (typeof html2canvas !== 'undefined') {
                    console.log('html2canvas loaded successfully');
                    window.exportLibraryStatus = 'html2canvas';
                } else {
                    console.error('html2canvas failed to load');
                    window.exportLibraryStatus = 'none';
                }
            }, 500);
        })();
    </script>
    
    <script>
        let allImagesLoaded = false;
        
        // Initialize global variables
        window.selectedQuality = 'standard'; // Default quality setting (changed from high)
        window.selectedExportFormat = '5x4'; // Default export format
        window.exportLibraryStatus = 'loading';
        window.currentDownloadProcess = null; // Track current download for cancellation
        
        // Initialize UI state
        function initializeUI() {
            const downloadBtn = document.getElementById('downloadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.textContent = '⏳ Initializing...';
            }
            
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
                cancelBtn.style.visibility = 'hidden';
                cancelBtn.textContent = '✖️ Cancel';
            }
        }
        
        // Reset UI to initial state
        function resetUI() {
            const downloadBtn = document.getElementById('downloadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            if (downloadBtn) {
                downloadBtn.disabled = false;
                downloadBtn.textContent = '📷 Download Image';
                downloadBtn.style.display = 'inline-block';
                downloadBtn.style.visibility = 'visible';
            }
            
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
                cancelBtn.style.visibility = 'hidden';
                cancelBtn.textContent = '✖️ Cancel';
                console.log('Cancel button should now be hidden');
            }
            
            window.currentDownloadProcess = null;
            console.log('UI reset complete');
        }
        
        // Quality settings function - defined early to avoid temporal dead zone
        function getQualitySettings(quality = window.selectedQuality || 'high') {
            const settings = {
                'standard': { scale: 2, timeout: 10000, description: 'Standard Quality (2x)' },
                'high': { scale: 3, timeout: 15000, description: 'High Quality (3x)' },
                'ultra': { scale: 4, timeout: 20000, description: 'Ultra Quality (4x)' }
            };
            
            return settings[quality] || settings.high;
        }
        
        // Wait for all images to load before allowing download (legacy function - now uses loadAllImagesWithProxy)
        function checkAllImagesLoaded() {
            const images = document.querySelectorAll('.card-image');
            const energyImages = document.querySelectorAll('.energy-badge');
            const allImages = [...images, ...energyImages];
            let loadedCount = 0;
            const totalImages = allImages.length;
            
            if (totalImages === 0) {
                allImagesLoaded = true;
                document.getElementById('downloadBtn').textContent = '📷 Download Image';
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('downloadBtn').focus();
                return;
            }
            
            function imageLoaded() {
                loadedCount++;
                console.log(`Images loaded: ${loadedCount}/${totalImages}`);
                
                if (loadedCount === totalImages) {
                    allImagesLoaded = true;
                    console.log('All images loaded! Enabling download button...');
                    
                    const downloadBtn = document.getElementById('downloadBtn');
                    if (downloadBtn) {
                        downloadBtn.textContent = '📷 Download Image';
                        downloadBtn.disabled = false;
                        downloadBtn.focus();
                        console.log('Download button enabled and focused');
                    }
                }
            }
            
            // Set initial button state
            document.getElementById('downloadBtn').textContent = '⏳ Loading High-Res Images...';
            document.getElementById('downloadBtn').disabled = true;
            
            // Check all images including energy badges
            allImages.forEach(img => {
                if (img.complete && (img.naturalWidth !== 0 || img.src.includes('placeholder'))) {
                    imageLoaded();
                } else {
                    img.onload = imageLoaded;
                    img.onerror = imageLoaded; // Count failed loads too
                }
            });
            
            // Safety timeout to prevent perpetual loading
            setTimeout(() => {
                if (!allImagesLoaded) {
                    allImagesLoaded = true;
                    document.getElementById('downloadBtn').textContent = '📷 Download Image';
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('downloadBtn').focus();
                }
            }, 15000); // 15 second timeout (increased for high-res loading)
        }
        
        // Initial check after page load - now handled in DOMContentLoaded
        window.addEventListener('load', function() {
            // Image loading now handled in DOMContentLoaded for faster startup
        });

        // New download functions for format selection
        window.showDownloadOptions = function showDownloadOptions() {
            // Show modal for quality and format selection
            const modal = document.getElementById('downloadModal');
            modal.style.display = 'flex';
            
            // Prevent body scrolling
            document.body.style.overflow = 'hidden';
            
            // Reset modal selections
            resetModalSelections();
            
            // Check if description exists and disable toggle if needed
            updateDescriptionToggle();
            
            // Add ESC key listener to close modal
            document.addEventListener('keydown', handleModalEscKey);
        }
        
        window.hideDownloadOptions = function hideDownloadOptions() {
            const modal = document.getElementById('downloadModal');
            modal.style.display = 'none';
            
            // Re-enable body scrolling
            document.body.style.overflow = '';
            
            // Remove ESC key listener when modal is closed
            document.removeEventListener('keydown', handleModalEscKey);
        }
        
        // Handle ESC key press to close modal
        function handleModalEscKey(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('downloadModal');
                if (modal && modal.style.display === 'flex') {
                    hideDownloadOptions();
                }
            }
        }
        
        // Modal selection variables
        let selectedModalQuality = null;
        let selectedModalFormat = null;
        let selectedModalTheme = null;
        
        function resetModalSelections() {
            // Set default values: 2x10, dark mode, standard quality
            selectedModalQuality = 'standard';
            selectedModalFormat = '2x10';
            selectedModalTheme = 'dark';
            
            // Reset button states
            document.querySelectorAll('#downloadModal .modal-option-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set default button states
            document.getElementById('modal-quality-standard').classList.add('active');
            document.getElementById('modal-format-2x10').classList.add('active');
            document.getElementById('modal-theme-dark').classList.add('active');
            
            // Reset checkboxes to default
            document.getElementById('modal-include-title').checked = true;
            document.getElementById('modal-include-description').checked = true;
            
            // Enable download button since defaults are set
            document.getElementById('modal-download-btn').disabled = false;
        }
        
        window.selectModalQuality = function selectModalQuality(quality) {
            selectedModalQuality = quality;
            
            // Update button states
            document.querySelectorAll('[id^="modal-quality-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('modal-quality-' + quality).classList.add('active');
            
            // Check if we can enable download
            updateModalDownloadButton();
        }
        
        window.selectModalFormat = function selectModalFormat(format) {
            selectedModalFormat = format;
            
            // Update button states
            document.querySelectorAll('[id^="modal-format-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('modal-format-' + format).classList.add('active');
            
            // Check if we can enable download
            updateModalDownloadButton();
        }
        
        window.selectModalTheme = function selectModalTheme(theme) {
            selectedModalTheme = theme;
            
            // Update button states
            document.querySelectorAll('[id^="modal-theme-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('modal-theme-' + theme).classList.add('active');
            
            // Check if we can enable download
            updateModalDownloadButton();
        }
        
        function updateModalDownloadButton() {
            const downloadBtn = document.getElementById('modal-download-btn');
            if (selectedModalQuality && selectedModalFormat && selectedModalTheme) {
                downloadBtn.disabled = false;
                downloadBtn.textContent = `📷 Download`;
            } else {
                downloadBtn.disabled = true;
                downloadBtn.textContent = '📷 Download';
            }
        }
        
        function updateDescriptionToggle() {
            const descriptionElement = document.querySelector('.deck-description');
            const descriptionToggle = document.querySelector('.modal-toggle:has(#modal-include-description)');
            const descriptionCheckbox = document.getElementById('modal-include-description');
            
            // Check if description exists and has meaningful content
            let hasDescription = false;
            if (descriptionElement) {
                const descText = descriptionElement.textContent.trim();
                // Check if there's content beyond just "Description:"
                if (descText.includes('Description:')) {
                    const contentAfterLabel = descText.replace('Description:', '').trim();
                    hasDescription = contentAfterLabel.length > 0;
                } else if (descText.length > 0) {
                    hasDescription = true;
                }
            }
            
            if (!hasDescription) {
                // No description - disable the toggle
                if (descriptionToggle) {
                    descriptionToggle.classList.add('disabled');
                }
                if (descriptionCheckbox) {
                    descriptionCheckbox.disabled = true;
                    descriptionCheckbox.checked = false;
                }
                console.log('Description toggle disabled - no description found');
            } else {
                // Description exists - enable the toggle
                if (descriptionToggle) {
                    descriptionToggle.classList.remove('disabled');
                }
                if (descriptionCheckbox) {
                    descriptionCheckbox.disabled = false;
                    descriptionCheckbox.checked = true;
                }
                console.log('Description toggle enabled - description found');
            }
        }
        
        window.downloadWithSelectedOptions = function downloadWithSelectedOptions() {
            if (!selectedModalQuality || !selectedModalFormat || !selectedModalTheme) {
                alert('Please select quality, format, and theme options.');
                return;
            }
            
            // Set the quality for the download
            window.selectedQuality = selectedModalQuality;
            
            // Get include options
            const includeTitle = document.getElementById('modal-include-title').checked;
            const includeDescription = document.getElementById('modal-include-description').checked;
            
            // Hide modal and start download
            hideDownloadOptions();
            downloadWithFormatAndOptions(selectedModalFormat, includeTitle, includeDescription, selectedModalTheme);
        }
        
        window.cancelDownload = function cancelDownload() {
            if (window.currentDownloadProcess) {
                window.currentDownloadProcess.cancelled = true;
                console.log('Download cancelled by user');
            }
            
            // Show cancellation feedback
            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) {
                cancelBtn.textContent = '✖️ Cancelling...';
                cancelBtn.disabled = true;
            }
            
            // Reset UI after brief delay
            setTimeout(() => {
                resetUI();
                hideDownloadOptions();
            }, 500);
        }
        
        window.downloadWithFormat = async function downloadWithFormat(format) {
            // Legacy function - redirect to new function with default options
            await downloadWithFormatAndOptions(format, true, true, null);
        }
        
        window.downloadWithFormatAndOptions = async function downloadWithFormatAndOptions(format, includeTitle, includeDescription, modalTheme) {
            console.log('Starting download with format:', format, 'includeTitle:', includeTitle, 'includeDescription:', includeDescription, 'theme:', modalTheme);
            
            // Hide modal and show cancel button
            hideDownloadOptions();
            const downloadBtn = document.getElementById('downloadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.textContent = '⏳ Generating...';
                downloadBtn.style.display = 'inline-block';
                downloadBtn.style.visibility = 'visible';
            }
            
            if (cancelBtn) {
                cancelBtn.style.display = 'inline-block';
                cancelBtn.style.visibility = 'visible';
                cancelBtn.disabled = false;
                cancelBtn.textContent = '✖️ Cancel';
                console.log('Cancel button should now be visible');
            }
            
            // Create download process tracker
            window.currentDownloadProcess = { cancelled: false };
            
            // Small delay to ensure UI updates before starting download
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Update cancel button to show progress
            if (cancelBtn) {
                cancelBtn.textContent = '✖️ Cancel';
            }
            
            try {
                await downloadAsImage(format, includeTitle, includeDescription, modalTheme);
            } catch (error) {
                console.error('Download with format failed:', error);
                // Error handling is done in downloadAsImage
            } finally {
                // Reset UI regardless of success/failure
                resetUI();
            }
        }
        
        async function downloadAsImage(downloadFormat, includeTitle = true, includeDescription = true, modalTheme = null) {
            if (!allImagesLoaded) {
                alert('Please wait for all images to load before downloading.');
                return;
            }
            if (typeof html2canvas === 'undefined') {
                alert('Image export library failed to load. Please refresh the page and try again.');
                return;
            }
        
            const sourceElement = document.getElementById('deck-export');
            const clone = sourceElement.cloneNode(true);
            clone.id = 'deck-export-clone'; // Use a unique ID for the clone
        
            // Function to ensure the clone is removed from the DOM
            const cleanupClone = () => {
                if (document.body.contains(clone)) {
                    document.body.removeChild(clone);
                }
            };
        
            try {
                // Prepare the clone with the correct theme and export styles
                document.body.appendChild(clone);
                clone.classList.add('is-export-clone', `export-prep-${downloadFormat}`);
                
                // Apply theme to the clone based on modal selection
                if (modalTheme === 'light') {
                    clone.classList.add('light-theme');
                } else if (!modalTheme && document.body.classList.contains('light-theme')) {
                    // Fallback to current theme if no modal theme specified
                    clone.classList.add('light-theme');
                }
                
                // Ensure the main export container maintains its styling
                const exportContainer = clone.querySelector('.export-container') || clone;
                
                // Get the theme to use for export (from modal selection or fallback to current theme)
                const currentTheme = modalTheme || (document.body.classList.contains('light-theme') ? 'light' : 'dark');
                
                if (exportContainer) {
                    const sourceStyles = getComputedStyle(sourceElement);
                    
                    // Apply theme-specific colors directly
                    if (currentTheme === 'light') {
                        exportContainer.style.background = '#ffffff';
                        exportContainer.style.color = '#333';
                        exportContainer.style.setProperty('--bg-color', '#f5f5f5');
                        exportContainer.style.setProperty('--container-bg', '#ffffff');
                        exportContainer.style.setProperty('--text-color', '#333');
                        exportContainer.style.setProperty('--title-color', '#333');
                        exportContainer.style.setProperty('--border-color', '#e0e0e0');
                        exportContainer.style.setProperty('--grid-bg', '#fafafa');
                        exportContainer.style.setProperty('--card-bg', '#fff');
                        exportContainer.style.setProperty('--card-border', '#ddd');
                        exportContainer.style.setProperty('--empty-card-bg', '#f8f8f8');
                        exportContainer.style.setProperty('--empty-card-border', '#ccc');
                        exportContainer.style.setProperty('--description-color', '#666');
                    } else {
                        exportContainer.style.background = '#34495e';
                        exportContainer.style.color = '#ddd';
                        exportContainer.style.setProperty('--bg-color', '#2d3436');
                        exportContainer.style.setProperty('--container-bg', '#34495e');
                        exportContainer.style.setProperty('--text-color', '#ddd');
                        exportContainer.style.setProperty('--title-color', '#ecf0f1');
                        exportContainer.style.setProperty('--border-color', '#5a6c7d');
                        exportContainer.style.setProperty('--grid-bg', '#2c3e50');
                        exportContainer.style.setProperty('--card-bg', '#34495e');
                        exportContainer.style.setProperty('--card-border', '#5a6c7d');
                        exportContainer.style.setProperty('--empty-card-bg', '#2c3e50');
                        exportContainer.style.setProperty('--empty-card-border', '#7f8c8d');
                        exportContainer.style.setProperty('--description-color', '#bdc3c7');
                    }
                    
                    // Apply essential container styling
                    exportContainer.style.fontFamily = sourceStyles.fontFamily || "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
                    exportContainer.style.borderRadius = '12px';
                    exportContainer.style.padding = '26px';
                    exportContainer.style.minHeight = 'fit-content';
                    exportContainer.style.overflow = 'visible';
                    exportContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                }
                
                // Handle title and description visibility and styling
                const deckHeader = clone.querySelector('.deck-header');
                if (deckHeader) {
                    if (!includeTitle) {
                        deckHeader.style.display = 'none';
                    } else {
                        // Apply theme-specific header styling
                        if (currentTheme === 'light') {
                            deckHeader.style.borderBottom = '2px solid #e0e0e0';
                            deckHeader.style.color = '#333';
                        } else {
                            deckHeader.style.borderBottom = '2px solid #5a6c7d';
                            deckHeader.style.color = '#ddd';
                        }
                        deckHeader.style.textAlign = 'center';
                        deckHeader.style.marginBottom = '20px';
                        deckHeader.style.paddingBottom = '15px';
                        
                        // Style the deck title
                        const deckTitle = deckHeader.querySelector('.deck-title');
                        if (deckTitle) {
                            deckTitle.style.fontSize = '1.8em';
                            deckTitle.style.fontWeight = '600';
                            deckTitle.style.margin = '0 0 8px 0';
                            if (currentTheme === 'light') {
                                deckTitle.style.color = '#333';
                            } else {
                                deckTitle.style.color = '#ecf0f1';
                            }
                        }
                        
                        // Style the deck creator
                        const deckCreator = deckHeader.querySelector('.deck-creator');
                        if (deckCreator) {
                            deckCreator.style.textAlign = 'center';
                            deckCreator.style.fontSize = '0.85em';
                            deckCreator.style.margin = '8px 0';
                            if (currentTheme === 'light') {
                                deckCreator.style.color = '#666';
                            } else {
                                deckCreator.style.color = '#bdc3c7';
                            }
                        }
                        
                        // Style the deck info (energy badges and card count)
                        const deckInfo = deckHeader.querySelector('.deck-info');
                        if (deckInfo) {
                            deckInfo.style.display = 'flex';
                            deckInfo.style.justifyContent = 'center';
                            deckInfo.style.alignItems = 'center';
                            deckInfo.style.gap = '15px';
                            deckInfo.style.margin = '10px 0';
                            
                            // Style energy badges
                            const energyBadges = deckInfo.querySelectorAll('.energy-badge');
                            energyBadges.forEach(badge => {
                                badge.style.width = '24px';
                                badge.style.height = '24px';
                                badge.style.borderRadius = '50%';
                                if (currentTheme === 'light') {
                                    badge.style.border = '1px solid #e0e0e0';
                                } else {
                                    badge.style.border = '1px solid #5a6c7d';
                                }
                                // Ensure crossorigin for html2canvas
                                badge.crossOrigin = 'anonymous';
                            });
                            
                            // Style card count
                            const cardCount = deckInfo.querySelector('.card-count');
                            if (cardCount) {
                                cardCount.style.background = '#95a5a6';
                                cardCount.style.color = '#2c3e50';
                                cardCount.style.padding = '4px 8px';
                                cardCount.style.borderRadius = '12px';
                                cardCount.style.fontWeight = '500';
                                cardCount.style.fontSize = '0.8em';
                            }
                        }
                    }
                }
                
                const deckDescription = clone.querySelector('.deck-description');
                if (deckDescription) {
                    if (!includeDescription) {
                        deckDescription.style.display = 'none';
                    } else {
                        // Apply theme-specific description styling
                        deckDescription.style.marginTop = '20px';
                        deckDescription.style.marginBottom = '10px';
                        deckDescription.style.fontSize = '0.9em';
                        deckDescription.style.lineHeight = '1.4';
                        deckDescription.style.marginLeft = 'auto';
                        deckDescription.style.marginRight = 'auto';
                        deckDescription.style.wordWrap = 'break-word';
                        deckDescription.style.textAlign = 'left';
                        deckDescription.style.padding = '15px 20px';
                        deckDescription.style.borderRadius = '8px';
                        
                        // Format-specific styling
                        if (downloadFormat === '2x10') {
                            // Dynamic width based on description length
                            const descLength = deckDescription.textContent.length;
                            let maxWidth;
                            if (descLength < 100) {
                                maxWidth = '300px';
                            } else if (descLength < 200) {
                                maxWidth = '450px';
                            } else if (descLength < 300) {
                                maxWidth = '550px';
                            } else {
                                maxWidth = '600px';
                            }
                            deckDescription.style.maxWidth = maxWidth;
                        } else {
                            deckDescription.style.maxWidth = '800px';
                        }
                        
                        if (currentTheme === 'light') {
                            deckDescription.style.color = '#666';
                            deckDescription.style.background = '#fff';
                            deckDescription.style.border = '1px solid #ddd';
                        } else {
                            deckDescription.style.color = '#bdc3c7';
                            deckDescription.style.background = '#34495e';
                            deckDescription.style.border = '1px solid #5a6c7d';
                        }
                    }
                }
        
                // Force remove all responsive classes and styling from the clone
                const cloneCardsContainer = clone.querySelector('.cards-container');
                const cloneCardsGrid = clone.querySelector('.cards-grid');
                const cloneCardSlots = clone.querySelectorAll('.card-slot');
                
                if (cloneCardsContainer) {
                    cloneCardsContainer.classList.remove('layout-2x10-container');
                    // Override only the problematic responsive properties, preserve base styling
                    cloneCardsContainer.style.padding = '8px';
                    cloneCardsContainer.style.margin = '15px auto';
                    cloneCardsContainer.style.overflow = 'visible';
                    cloneCardsContainer.style.overflowX = 'visible';
                    cloneCardsContainer.style.overflowY = 'visible';
                    cloneCardsContainer.style.display = 'flex';
                    cloneCardsContainer.style.justifyContent = 'center';
                    cloneCardsContainer.style.alignItems = 'center';
                    cloneCardsContainer.style.maxWidth = 'none';
                    cloneCardsContainer.style.width = 'fit-content';
                    
                    // Ensure perfect centering for both layouts
                    if (downloadFormat === '2x10') {
                        cloneCardsContainer.style.width = '1163px';
                        cloneCardsContainer.style.padding = '5px';
                        cloneCardsContainer.style.margin = '15px auto';
                        cloneCardsContainer.style.justifyContent = 'center';
                        cloneCardsContainer.style.alignItems = 'center';
                    } else if (downloadFormat === '5x4') {
                        cloneCardsContainer.style.width = '455px';
                        cloneCardsContainer.style.padding = '6px';
                        cloneCardsContainer.style.margin = '15px auto';
                        cloneCardsContainer.style.justifyContent = 'center';
                        cloneCardsContainer.style.alignItems = 'center';
                    }
                    
                    // Apply theme-specific container styling
                    if (currentTheme === 'light') {
                        cloneCardsContainer.style.background = '#fafafa';
                        cloneCardsContainer.style.border = '1px solid #e0e0e0';
                    } else {
                        cloneCardsContainer.style.background = '#2c3e50';
                        cloneCardsContainer.style.border = '1px solid #5a6c7d';
                    }
                    cloneCardsContainer.style.borderRadius = '8px';
                }
                
                if (cloneCardsGrid) {
                    cloneCardsGrid.classList.remove('layout-2x10', 'layout-5x4', 'auto-mobile', 'auto-desktop');
                    // Override only the problematic responsive properties, preserve base styling
                    cloneCardsGrid.style.gap = '8px';
                    cloneCardsGrid.style.margin = '0';
                    cloneCardsGrid.style.overflow = 'visible';
                    cloneCardsGrid.style.maxWidth = 'none';
                    cloneCardsGrid.style.minWidth = 'initial';
                    cloneCardsGrid.style.flexShrink = '0';
                    
                    // Apply layout-specific grid settings
                    if (downloadFormat === '2x10') {
                        cloneCardsGrid.style.display = 'grid';
                        cloneCardsGrid.style.gridTemplateColumns = 'repeat(10, 110.9px)';
                        cloneCardsGrid.style.gridTemplateRows = 'repeat(2, auto)';
                        cloneCardsGrid.style.width = '1156px';
                        cloneCardsGrid.style.margin = '0 auto';
                        cloneCardsGrid.style.justifyContent = 'center';
                    } else if (downloadFormat === '5x4') {
                        cloneCardsGrid.style.display = 'grid';
                        cloneCardsGrid.style.gridTemplateColumns = 'repeat(4, 105px)';
                        cloneCardsGrid.style.gridTemplateRows = 'repeat(5, auto)';
                        cloneCardsGrid.style.width = '450px';
                        cloneCardsGrid.style.margin = '0 auto';
                        cloneCardsGrid.style.justifyContent = 'center';
                    }
                }
                
                // Force reset all card slots to standard size while preserving base styling
                cloneCardSlots.forEach(slot => {
                    // Don't clear cssText completely - preserve base card styling
                    slot.style.width = '110px';
                    slot.style.height = '154px';
                    slot.style.maxWidth = '110px';
                    slot.style.minWidth = '110px';
                    slot.style.flexShrink = '0';
                    slot.style.flexGrow = '0';
                    // Ensure the card maintains its visual properties
                    slot.style.aspectRatio = '63/88';
                    slot.style.borderRadius = '3.5%';
                    slot.style.overflow = 'hidden';
                    slot.style.position = 'relative';
                    slot.style.boxShadow = '0 1px 2px rgba(0,0,0,0.2)';
                    
                    // Apply theme-specific card styling
                    if (slot.classList.contains('empty')) {
                        if (currentTheme === 'light') {
                            slot.style.background = '#f8f8f8';
                            slot.style.border = '2px dashed #ccc';
                        } else {
                            slot.style.background = '#2c3e50';
                            slot.style.border = '2px dashed #7f8c8d';
                        }
                        slot.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
                        slot.style.opacity = '0.8';
                    } else {
                        if (currentTheme === 'light') {
                            slot.style.background = '#fff';
                        } else {
                            slot.style.background = '#34495e';
                        }
                        slot.style.border = 'none';
                    }
                    
                    // Ensure card images are properly styled in the clone
                    const cardImage = slot.querySelector('.card-image');
                    if (cardImage) {
                        cardImage.style.width = '100%';
                        cardImage.style.height = '100%';
                        cardImage.style.objectFit = 'cover';
                        cardImage.style.display = 'block';
                        cardImage.style.borderRadius = '3.5%';
                        // Ensure crossorigin for html2canvas
                        cardImage.crossOrigin = 'anonymous';
                    }
                });
        
                const qualitySettings = getQualitySettings();
                const bgColor = currentTheme === 'light' ? '#ffffff' : getComputedStyle(sourceElement).backgroundColor;
        
                // Extended delay to allow the browser to apply all styles to the off-screen clone
                await new Promise(resolve => setTimeout(resolve, 200));
        
                // Debug: Log clone styling
                console.log('Clone styles after preparation:');
                console.log('Clone background:', getComputedStyle(clone).background);
                console.log('Clone width:', clone.offsetWidth);
                console.log('Clone height:', clone.offsetHeight);
                console.log('Export container background:', getComputedStyle(exportContainer).background);
                console.log('Cards container background:', getComputedStyle(cloneCardsContainer).background);
        
                if (window.currentDownloadProcess?.cancelled) {
                     console.log('Download cancelled before capture.');
                     throw new Error('Download cancelled');
                }
        
                // Update progress
                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    downloadBtn.textContent = '🖼️ Capturing...';
                }
        
                // Temporarily move clone to a better position for html2canvas
                clone.style.left = '0px';
                clone.style.top = '0px';
                clone.style.position = 'absolute';
                clone.style.zIndex = '-1'; // Behind everything but still renderable
                
                // Wait a bit for the position change to take effect
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Create a cancellable html2canvas promise with enhanced options
                const canvas = await new Promise((resolve, reject) => {
                    // Check for cancellation before starting
                    if (window.currentDownloadProcess?.cancelled) {
                        reject(new Error('Download cancelled'));
                        return;
                    }
                    
                    html2canvas(clone, {
                        scale: qualitySettings.scale,
                        useCORS: true,
                        backgroundColor: bgColor,
                        logging: true, // Enable logging to debug issues
                        imageTimeout: qualitySettings.timeout,
                        // Enhanced options for better export quality
                        allowTaint: false, // Try with false first
                        foreignObjectRendering: false, // Disable for better compatibility
                        removeContainer: false,
                        width: clone.offsetWidth,
                        height: clone.offsetHeight,
                        scrollX: 0,
                        scrollY: 0,
                        x: 0,
                        y: 0,
                        // Force html2canvas to use the full element
                        windowWidth: clone.offsetWidth,
                        windowHeight: clone.offsetHeight,
                        ignoreElements: function(element) {
                            // Don't ignore any elements in the clone
                            return false;
                        }
                    }).then(canvas => {
                        // Check for cancellation after completion
                        if (window.currentDownloadProcess?.cancelled) {
                            reject(new Error('Download cancelled'));
                            return;
                        }
                        resolve(canvas);
                    }).catch(reject);
                });
        
                // Check for cancellation after html2canvas completes
                if (window.currentDownloadProcess?.cancelled) {
                    console.log('Download cancelled after image generation.');
                    throw new Error('Download cancelled');
                }
        
                // Update progress
                if (downloadBtn) {
                    downloadBtn.textContent = '💾 Saving...';
                }
        
                const dataUrl = canvas.toDataURL('image/png', 1.0);
                
                // Check for cancellation before starting download
                if (window.currentDownloadProcess?.cancelled) {
                    console.log('Download cancelled before file download.');
                    throw new Error('Download cancelled');
                }
                
                const deckName = '{{ deck.name|replace(" ", "_")|replace(".", "") }}';
        
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `${deckName}_${downloadFormat}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
        
            } catch (error) {
                if (error.message === 'Download cancelled') {
                    console.log('Download was cancelled by user');
                    // Don't show an error for cancellation
                } else {
                    console.error('Failed to generate image:', error);
                    alert('An error occurred while generating the image. Check the console for details.');
                }
            } finally {
                cleanupClone(); // Always remove the clone
            }
        }
        
        // Store current layout preference
        window.userLayoutPreference = 'auto'; // 'auto' = automatic, '2x10' = force 2x10, '5x4' = force 5x4
        
        window.toggleLayout = function toggleLayout(layout) {
            
            try {
                const buttons = document.querySelectorAll('#layout-auto, #layout-2x10, #layout-5x4');
                buttons.forEach(btn => btn.classList.remove('active'));
                
                // Store user preference
                window.userLayoutPreference = layout;
                document.getElementById('layout-' + layout).classList.add('active');
                
                if (layout === 'auto') {
                    // Enable automatic layout detection
                    checkAndApplyAutoLayout();
                } else {
                    // Apply specific forced layout
                    applySpecificLayout(layout);
                }
                
                
            } catch (error) {
                console.error('Error in toggleLayout:', error);
            }
        }
        
        function applySpecificLayout(layoutType) {
            const grid = document.getElementById('cards-grid');
            const container = document.querySelector('.cards-container');
            
            // Clear sizing cache when applying specific layout to force recalculation
            sizingCache.layout2x10 = { containerWidth: 0, bestCardWidth: 0, bestGap: 0 };
            sizingCache.layout5x4 = { containerWidth: 0, bestCardWidth: 0, bestGap: 0 };
            
            // Remove all layout classes
            grid.classList.remove('layout-2x10', 'layout-5x4', 'auto-mobile', 'auto-desktop');
            container.classList.remove('layout-2x10-container');
            
            // Reset any dynamic sizing applied to card slots
            const cardSlots = document.querySelectorAll('.card-slot');
            cardSlots.forEach(slot => {
                slot.style.width = '';
                slot.style.maxWidth = '';
                slot.style.height = '';
            });
            
            // Reset grid styling completely
            if (grid) {
                grid.style.gap = '';
                grid.style.width = '';
                grid.style.maxWidth = '';
                grid.style.minWidth = '';
                grid.style.gridTemplateColumns = '';
                grid.style.gridTemplateRows = '';
            }
            
            // Reset container styling completely
            container.style.width = '';
            container.style.maxWidth = '';
            container.style.margin = '';
            container.style.overflowX = '';
            container.style.overflowY = '';
            container.style.justifyContent = '';
            container.style.alignItems = '';
            container.style.paddingLeft = '';
            container.style.paddingRight = '';
            container.style.paddingTop = '';
            container.style.paddingBottom = '';
            
            // Apply specific layout
            grid.classList.add('layout-' + layoutType);
            
            // Add container classes and apply appropriate overflow settings
            if (layoutType === '2x10') {
                container.classList.add('layout-2x10-container');
                // Ensure container can show all content initially
                container.style.overflow = 'visible';
                container.style.overflowY = 'visible';
                // Don't set overflow here - let applyDynamicSizing2x10 handle it based on screen size
                // Apply dynamic sizing for 2x10 layout immediately
                console.log('Applying manual 2x10 layout');
                applyDynamicSizing2x10();
            } else if (layoutType === '5x4') {
                // Ensure clean container state for 5x4 layout - no scrolling
                container.style.overflowX = 'hidden';
                container.style.overflowY = 'hidden';
                
                // Apply dynamic sizing for 5x4 layout immediately
                applyDynamicSizing5x4();
            }
            
        }
        
        // Dynamic sizing function for 2x10 layout to perfectly fit the screen
        function applyDynamicSizing2x10() {
            const container = document.querySelector('.export-container');
            const cardsContainer = document.querySelector('.cards-container.layout-2x10-container');
            
            // Skip dynamic sizing for hidden export containers
            if (!container || !cardsContainer || container.id === 'download-2x10' || container.id === 'download-5x4') return;
            
            // Calculate available width more precisely
            const containerWidth = container.offsetWidth;
            
            // Early exit if dimensions haven't changed and we're still in 2x10 mode
            const currentLayout = document.querySelector('.cards-grid.layout-2x10');
            if (sizingCache.layout2x10.containerWidth === containerWidth && currentLayout) {
                return;
            }
            
            const containerStyle = getComputedStyle(container);
            const containerPadding = parseInt(containerStyle.paddingLeft) + parseInt(containerStyle.paddingRight);
            
            const cardsContainerStyle = getComputedStyle(cardsContainer);
            const cardsContainerPadding = parseInt(cardsContainerStyle.paddingLeft) + parseInt(cardsContainerStyle.paddingRight);
            
            // Available width is container width minus all padding with small buffer for precision
            const availableWidth = containerWidth - containerPadding - cardsContainerPadding - 4; // Small buffer to prevent overflow
            
            // Calculate optimal card size for 10 cards
            const cardCount = 10;
            const minGap = 6;
            const maxGap = 12;
            const minCardWidth = 90;
            const maxCardWidth = 200;
            
            // Try different card sizes to find the best fit
            let bestCardWidth = minCardWidth;
            let bestGap = minGap;
            
            for (let cardWidth = maxCardWidth; cardWidth >= minCardWidth; cardWidth -= 1) {
                const gap = Math.max(minGap, Math.min(maxGap, Math.floor((availableWidth - (cardCount * cardWidth)) / (cardCount - 1))));
                const totalWidth = (cardCount * cardWidth) + ((cardCount - 1) * gap);
                
                if (totalWidth <= availableWidth) {
                    bestCardWidth = cardWidth;
                    bestGap = gap;
                    break;
                }
            }
            
            // Cache the calculated values
            sizingCache.layout2x10 = { containerWidth, bestCardWidth, bestGap };
            
            // Calculate the total grid width
            const totalGridWidth = (cardCount * bestCardWidth) + ((cardCount - 1) * bestGap);
            
            // Check if we're on a smaller screen (threshold for when to allow scrolling)
            const isSmallScreen = window.innerWidth < 1200; // Adjust threshold as needed
            
            // Batch DOM operations - read all elements first
            const cardSlots = document.querySelectorAll('.cards-grid.layout-2x10 .card-slot');
            const grid = document.querySelector('.cards-grid.layout-2x10');
            
            // Apply all styles in one batch to prevent style thrashing
            // Add resizing class to disable transitions
            cardsContainer.classList.add('resizing');
            
            requestAnimationFrame(() => {
                // Apply card styles
                cardSlots.forEach(slot => {
                    slot.style.width = `${bestCardWidth}px`;
                    slot.style.maxWidth = `${bestCardWidth}px`;
                    slot.style.height = `${bestCardWidth * (88/63)}px`; // Maintain 63/88 aspect ratio
                });
                
                // Apply grid styles - ensure it's a CSS grid with proper 2x10 layout
                if (grid) {
                    grid.style.display = 'grid';
                    grid.style.gridTemplateColumns = 'repeat(10, auto)';
                    grid.style.gridTemplateRows = 'repeat(2, auto)';
                    grid.style.gap = `${bestGap}px`;
                    grid.style.width = `${totalGridWidth}px`;
                    grid.style.maxWidth = `${availableWidth}px`;
                }
                
                // Apply container styles
                cardsContainer.style.width = `${containerWidth - containerPadding}px`;
                cardsContainer.style.maxWidth = `${containerWidth - containerPadding}px`;
                cardsContainer.style.margin = '15px auto';
                
                // Adjust container behavior based on screen size and whether grid fits
                if (isSmallScreen && totalGridWidth > availableWidth) {
                    // Small screen and grid doesn't fit - allow horizontal scrolling
                    cardsContainer.style.justifyContent = 'flex-start';
                    cardsContainer.style.alignItems = 'center';
                    cardsContainer.style.overflowX = 'auto';
                    cardsContainer.style.overflowY = 'hidden';
                    if (grid) {
                        grid.style.margin = '0';
                        grid.style.minWidth = `${totalGridWidth}px`;
                        grid.style.width = `${totalGridWidth}px`;
                        grid.style.maxWidth = 'none';
                    }
                } else {
                    // Default/large screen or grid fits - center and no scrolling
                    cardsContainer.style.justifyContent = 'center';
                    cardsContainer.style.alignItems = 'center';
                    cardsContainer.style.overflowX = 'hidden';
                    cardsContainer.style.overflowY = 'hidden';
                    if (grid) {
                        grid.style.margin = '0';
                        grid.style.minWidth = 'fit-content';
                        grid.style.width = 'fit-content';
                        grid.style.maxWidth = `${availableWidth}px`;
                    }
                }
                
                // Remove resizing class after styles are applied
                requestAnimationFrame(() => {
                    cardsContainer.classList.remove('resizing');
                });
            });
            
        }
        
        // Dynamic sizing function for 5x4 layout to maintain compact appearance like 2x10
        function applyDynamicSizing5x4() {
            const container = document.querySelector('.export-container');
            const cardsContainer = document.querySelector('.cards-container');
            
            // Skip dynamic sizing for hidden export containers
            if (!container || !cardsContainer || container.id === 'download-2x10' || container.id === 'download-5x4') return;
            
            // Calculate available width more precisely (similar to 2x10 approach)
            const containerWidth = container.offsetWidth;
            
            // Early exit if dimensions haven't changed and we're still in 5x4 mode
            const currentLayout = document.querySelector('.cards-grid.layout-5x4');
            if (sizingCache.layout5x4.containerWidth === containerWidth && currentLayout) {
                return;
            }
            
            const containerStyle = getComputedStyle(container);
            const containerPadding = parseInt(containerStyle.paddingLeft) + parseInt(containerStyle.paddingRight);
            
            // Use consistent padding approach like 2x10, but account for mobile overflow
            const cardsContainerPadding = 16; // Fixed padding for consistency
            const mobileBuffer = window.innerWidth <= 800 ? 20 : 10; // Extra buffer for mobile
            
            // Available width calculation with mobile buffer to prevent overflow
            const availableWidth = containerWidth - containerPadding - cardsContainerPadding - mobileBuffer;
            
            // Calculate optimal card size for 4 cards per row (5x4 layout)
            const cardsPerRow = 4;
            const minGap = 6; // Minimum gap for clean look
            const maxGap = 10; // Maximum gap for visual appeal
            const minCardWidth = 60; // More aggressive minimum for mobile
            const maxCardWidth = 140; // Maximum preferred size
            
            // Always fit all cards on screen - be more aggressive with sizing
            let bestCardWidth = minCardWidth;
            let bestGap = minGap;
            
            // Calculate what card width fits with minimum gap
            const gapWidth = (cardsPerRow - 1) * minGap;
            const calculatedCardWidth = Math.floor((availableWidth - gapWidth) / cardsPerRow);
            
            if (calculatedCardWidth >= minCardWidth) {
                bestCardWidth = Math.min(calculatedCardWidth, maxCardWidth);
                bestGap = minGap;
                
                // Try to increase gap if we have extra space
                const remainingSpace = availableWidth - (cardsPerRow * bestCardWidth) - ((cardsPerRow - 1) * minGap);
                if (remainingSpace > 0) {
                    const additionalGap = Math.floor(remainingSpace / (cardsPerRow - 1));
                    bestGap = Math.min(minGap + additionalGap, maxGap);
                }
            } else {
                // If we can't fit with minimum gap, reduce card size to fit
                bestCardWidth = Math.max(minCardWidth, Math.floor((availableWidth - gapWidth) / cardsPerRow));
                bestGap = minGap;
            }
            
            // Cache the calculated values
            sizingCache.layout5x4 = { containerWidth, bestCardWidth, bestGap };
            
            // Calculate total grid width
            const totalGridWidth = (cardsPerRow * bestCardWidth) + ((cardsPerRow - 1) * bestGap);
            
            // Batch DOM operations - read all elements first
            const cardSlots = document.querySelectorAll('.cards-grid.layout-5x4 .card-slot');
            const gridElement = document.querySelector('.cards-grid.layout-5x4');
            
            // Apply all styles in one batch to prevent style thrashing
            // Add resizing class to disable transitions
            cardsContainer.classList.add('resizing');
            
            requestAnimationFrame(() => {
                // Apply card styles
                cardSlots.forEach(slot => {
                    slot.style.width = `${bestCardWidth}px`;
                    slot.style.maxWidth = `${bestCardWidth}px`;
                    slot.style.height = `${bestCardWidth * (88/63)}px`; // Maintain 63/88 aspect ratio
                });
                
                // Apply grid styles - ensure it's a CSS grid with proper 5x4 layout
                if (gridElement) {
                    gridElement.style.display = 'grid';
                    gridElement.style.gridTemplateColumns = 'repeat(4, auto)';
                    gridElement.style.gridTemplateRows = 'repeat(5, auto)';
                    gridElement.style.gap = `${bestGap}px`;
                    gridElement.style.width = `${totalGridWidth}px`;
                    gridElement.style.maxWidth = `${Math.min(totalGridWidth, availableWidth)}px`; // Ensure grid doesn't exceed available space
                }
                
                // Apply container styles for 5x4 - always fit all cards, no scrolling
                cardsContainer.style.width = 'fit-content';
                cardsContainer.style.maxWidth = `${containerWidth - containerPadding - mobileBuffer}px`;
                cardsContainer.style.margin = '15px auto';
                cardsContainer.style.display = 'flex';
                cardsContainer.style.justifyContent = 'center';
                cardsContainer.style.alignItems = 'center';
                cardsContainer.style.padding = '8px';
                cardsContainer.style.overflowX = 'hidden'; // No horizontal scrolling for 5x4
                cardsContainer.style.overflowY = 'hidden';
                
                // Remove resizing class after styles are applied
                requestAnimationFrame(() => {
                    cardsContainer.classList.remove('resizing');
                });
            });
            
        }
        
        function checkAndApplyAutoLayout() {
            // Only apply auto layout if user is in auto mode
            if (window.userLayoutPreference !== 'auto') {
                return; // User has forced a specific layout
            }
            
            // Clear sizing cache when auto layout runs to force recalculation
            sizingCache.layout2x10 = { containerWidth: 0, bestCardWidth: 0, bestGap: 0 };
            sizingCache.layout5x4 = { containerWidth: 0, bestCardWidth: 0, bestGap: 0 };
            
            const grid = document.getElementById('cards-grid');
            const container = document.querySelector('.cards-container');
            const containerWidth = container ? container.offsetWidth : document.querySelector('.export-container').offsetWidth;
            
            // Calculate if 2x10 layout fits - be more generous with the threshold
            const layout2x10Width = (10 * 110) + (9 * 8) + (2 * 40); // cards + gaps + container padding (more generous)
            const layout5x4Width = (4 * 110) + (3 * 8) + (2 * 40);   // cards + gaps + container padding
            
            
            // Remove all layout classes
            grid.classList.remove('layout-2x10', 'layout-5x4', 'auto-mobile', 'auto-desktop');
            container.classList.remove('layout-2x10-container');
            
            // Don't update layout buttons in auto mode - keep Auto active
            const autoButton = document.getElementById('layout-auto');
            const buttons = document.querySelectorAll('#layout-auto, #layout-2x10, #layout-5x4');
            buttons.forEach(btn => btn.classList.remove('active'));
            autoButton.classList.add('active');
            
            // Use export container width for better calculation
            const exportContainerWidth = document.querySelector('.export-container').offsetWidth;
            
            // Prefer 2x10 layout if it can reasonably fit OR if screen is large enough to handle scrolling
            const isLargeScreen = window.innerWidth >= 1200;
            const canFit2x10 = exportContainerWidth >= layout2x10Width * 0.85; // 85% threshold for better switching
            
            // Debug logging for troubleshooting
            console.log('Auto layout check:', {
                windowWidth: window.innerWidth,
                exportContainerWidth,
                layout2x10Width,
                canFit2x10,
                isLargeScreen
            });
            
            if (canFit2x10 || isLargeScreen) { // Use 2x10 if it fits or on large screens
                // Use 2x10 layout for desktop
                grid.classList.add('layout-2x10', 'auto-desktop');
                container.classList.add('layout-2x10-container');
                // Apply dynamic sizing for 2x10 layout immediately
                applyDynamicSizing2x10();
            } else {
                // Use 5x4 layout for mobile - reset any dynamic sizing first
                const cardSlots = document.querySelectorAll('.card-slot');
                cardSlots.forEach(slot => {
                    slot.style.width = '';
                    slot.style.maxWidth = '';
                    slot.style.height = '';
                });
                
                if (grid) {
                    grid.style.gap = '';
                    grid.style.width = '';
                    grid.style.maxWidth = '';
                    grid.style.minWidth = '';
                    grid.style.gridTemplateColumns = '';
                    grid.style.gridTemplateRows = '';
                }
                
                container.style.width = '';
                container.style.maxWidth = '';
                container.style.margin = '';
                container.style.overflowX = '';
                container.style.overflowY = '';
                container.style.justifyContent = '';
                container.style.alignItems = '';
                container.style.padding = '';
                
                grid.classList.add('layout-5x4', 'auto-mobile');
                // Apply dynamic sizing for 5x4 layout in auto mode immediately
                applyDynamicSizing5x4();
            }
        }
        
        window.toggleTheme = function toggleTheme(theme) {
            try {
                console.log('toggleTheme called with:', theme);
                const body = document.body;
                const buttons = document.querySelectorAll('#theme-dark, #theme-light');
                
                buttons.forEach(btn => btn.classList.remove('active'));
                
                if (theme === 'light') {
                    body.classList.add('light-theme');
                    document.getElementById('theme-light').classList.add('active');
                } else {
                    body.classList.remove('light-theme');
                    document.getElementById('theme-dark').classList.add('active');
                }
                console.log('Theme changed successfully to:', theme);
            } catch (error) {
                console.error('Error in toggleTheme:', error);
            }
        }
        
        window.toggleQuality = function toggleQuality(quality) {
            try {
                console.log('toggleQuality called with:', quality);
                const buttons = document.querySelectorAll('#quality-standard, #quality-high, #quality-ultra');
                
                if (buttons.length === 0) {
                    console.error('No quality buttons found!');
                    return;
                }
                
                buttons.forEach(btn => btn.classList.remove('active'));
                const targetButton = document.getElementById('quality-' + quality);
                
                if (!targetButton) {
                    console.error('Target quality button not found:', 'quality-' + quality);
                    return;
                }
                
                targetButton.classList.add('active');
                
                // Store quality setting for download function
                window.selectedQuality = quality;
                
                console.log('Quality setting changed successfully to:', quality);
            } catch (error) {
                console.error('Error in toggleQuality:', error);
            }
        }
        
        window.toggleExportFormat = function toggleExportFormat(format) {
            try {
                console.log('toggleExportFormat called with:', format);
                const buttons = document.querySelectorAll('#export-2x10, #export-5x4');
                
                if (buttons.length === 0) {
                    console.error('No export format buttons found!');
                    return;
                }
                
                buttons.forEach(btn => btn.classList.remove('active'));
                const targetButton = document.getElementById('export-' + format);
                
                if (!targetButton) {
                    console.error('Target export format button not found:', 'export-' + format);
                    return;
                }
                
                targetButton.classList.add('active');
                
                // Store export format setting for download function
                window.selectedExportFormat = format;
                
                console.log('Export format setting changed successfully to:', format);
            } catch (error) {
                console.error('Error in toggleExportFormat:', error);
            }
        }
        
        // Handle high-res image loading with fallback
        function handleImageError(img) {
            const fallbackSrc = img.getAttribute('data-fallback-src');
            const originalSrc = img.getAttribute('data-original-src');
            
            console.log('Image error for:', img.src);
            console.log('Fallback src:', fallbackSrc);
            console.log('Original src:', originalSrc);
            
            if (img.src !== fallbackSrc && fallbackSrc) {
                console.log('Trying fallback src');
                img.src = fallbackSrc;
            } else if (originalSrc && originalSrc !== img.src) {
                // Try original source through proxy
                const proxySrc = '/api/proxy-image?url=' + encodeURIComponent(originalSrc);
                console.log('Trying proxy src:', proxySrc);
                img.src = proxySrc;
            } else {
                // If all fails, use inline SVG placeholder
                console.log('Using placeholder');
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBoZWlnaHQ9IjE1NCIgdmlld0JveD0iMCAwIDExMCAxNTQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iMCIgeTE9IjAiIHgyPSIxIiB5Mj0iMCI+PHN0b3Agc3RvcC1jb2xvcj0iIzM0NDk1ZSIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzJjM2U1MCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMTAiIGhlaWdodD0iMTU0IiBmaWxsPSJ1cmwoI2EpIiByeD0iNiIvPjx0ZXh0IHg9IjU1IiB5PSI3NyIgZmlsbD0iIzk1YTVhNiIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkNhcmQ8L3RleHQ+PC9zdmc+';
            }
        }
        
        // High-resolution first image loading system
        async function loadAllImagesWithProxy() {
            // Prevent duplicate loading
            if (allImagesLoaded) {
                console.log('Images already loaded, skipping duplicate load');
                return;
            }
            
            console.log('Loading all images with high-res priority...');
            const images = document.querySelectorAll('.card-image');
            const energyIcons = document.querySelectorAll('.energy-badge');
            
            const imagesToLoad = images.length + energyIcons.length;
            console.log(`Found ${images.length} card images and ${energyIcons.length} energy icons`);
            console.log(`Total images to load: ${imagesToLoad}`);
            
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.disabled = true;
            downloadBtn.textContent = '⏳ Loading High-Res Images...';
            
            // Load high-resolution images first (with fallback to standard)
            console.log('Loading high-resolution images (with fallback to standard)...');
            await loadHighResolutionImages(images, energyIcons);
            
            // Enable download button only after all images are loaded with best quality
            downloadBtn.disabled = false;
            downloadBtn.textContent = '📷 Download Image';
            downloadBtn.focus();
            console.log('All images loaded with best available quality - download enabled');
            allImagesLoaded = true;
            
            // Apply layout after images are loaded immediately
            if (window.userLayoutPreference === 'auto') {
                checkAndApplyAutoLayout();
            } else if (window.userLayoutPreference === '5x4') {
                applyDynamicSizing5x4();
            }
        }
        
        // Load high-resolution images first with fallback to standard
        async function loadHighResolutionImages(images, energyIcons) {
            const imagePromises = [];
            let loadedCount = 0;
            const totalImages = images.length + energyIcons.length;
            
            function updateProgress() {
                loadedCount++;
                const percentage = Math.round((loadedCount / totalImages) * 100);
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.textContent = `⏳ Loading High-Res Images... ${percentage}%`;
                console.log(`High-res loading progress: ${loadedCount}/${totalImages} (${percentage}%)`);
            }
            
            // Load high-resolution card images (with fallback to standard)
            images.forEach(img => {
                const originalSrc = img.getAttribute('data-original-src');
                if (originalSrc && (originalSrc.includes('storage.googleapis.com') || originalSrc.includes('firebasestorage.googleapis.com'))) {
                    const promise = loadBestAvailableImage(img, originalSrc).then(() => {
                        updateProgress();
                    });
                    imagePromises.push(promise);
                } else {
                    updateProgress();
                }
            });
            
            // Load energy icons
            energyIcons.forEach(icon => {
                const originalSrc = icon.getAttribute('data-original-src');
                if (originalSrc && (originalSrc.includes('storage.googleapis.com') || originalSrc.includes('firebasestorage.googleapis.com'))) {
                    const promise = loadEnergyIcon(icon, originalSrc).then(() => {
                        updateProgress();
                    });
                    imagePromises.push(promise);
                } else {
                    updateProgress();
                }
            });
            
            await Promise.all(imagePromises);
        }
        
        // Load best available image (high-res first, fallback to standard)
        function loadBestAvailableImage(img, originalSrc) {
            return new Promise((resolve) => {
                // Try high-res first
                const highResSrc = originalSrc.replace('/cards/', '/high_res_cards/');
                const highResProxy = `/api/proxy-image?url=${encodeURIComponent(highResSrc)}`;
                
                const testHighRes = new Image();
                testHighRes.onload = function() {
                    img.src = highResProxy;
                    img.dataset.loadedResolution = 'high';
                    resolve();
                };
                testHighRes.onerror = function() {
                    // Fallback to standard resolution
                    const standardProxy = `/api/proxy-image?url=${encodeURIComponent(originalSrc)}`;
                    
                    const testStandard = new Image();
                    testStandard.onload = function() {
                        img.src = standardProxy;
                        img.dataset.loadedResolution = 'standard';
                        resolve();
                    };
                    testStandard.onerror = function() {
                        // Use placeholder if both fail
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBoZWlnaHQ9IjE1NCIgdmlld0JveD0iMCAwIDExMCAxNTQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iMCIgeTE9IjAiIHgyPSIxIiB5Mj0iMCI+PHN0b3Agc3RvcC1jb2xvcj0iIzM0NDk1ZSIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzJjM2U1MCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMTAiIGhlaWdodD0iMTU0IiBmaWxsPSJ1cmwoI2EpIiByeD0iNiIvPjx0ZXh0IHg9IjU1IiB5PSI3NyIgZmlsbD0iIzk1YTVhNiIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkNhcmQ8L3RleHQ+PC9zdmc+';
                        img.dataset.loadedResolution = 'placeholder';
                        resolve();
                    };
                    testStandard.src = standardProxy;
                };
                testHighRes.src = highResProxy;
            });
        }
        
        
        // Intelligent preloading system
        function implementIntelligentPreloading() {
            // Get all card images that haven't been loaded yet
            const images = document.querySelectorAll('.card-image');
            const imagesToPreload = [];
            
            images.forEach(img => {
                const originalSrc = img.getAttribute('data-original-src');
                if (originalSrc && !img.dataset.loadedResolution) {
                    imagesToPreload.push({
                        element: img,
                        src: originalSrc,
                        priority: calculatePreloadPriority(img)
                    });
                }
            });
            
            // Sort by priority (higher priority first)
            imagesToPreload.sort((a, b) => b.priority - a.priority);
            
            // Preload images with delays to avoid overwhelming the network
            imagesToPreload.forEach((item, index) => {
                const delay = index * 100; // 100ms delay between each preload
                setTimeout(() => {
                    preloadImage(item.element, item.src);
                }, delay);
            });
        }
        
        function calculatePreloadPriority(img) {
            let priority = 0;
            
            // Higher priority for images currently in viewport
            if (isInViewport(img)) {
                priority += 100;
            }
            
            // Higher priority for images near viewport
            if (isNearViewport(img)) {
                priority += 50;
            }
            
            // Higher priority for images in the first row (5x4 layout)
            const rect = img.getBoundingClientRect();
            if (rect.top < window.innerHeight * 0.5) {
                priority += 30;
            }
            
            // Higher priority for images that are likely to be viewed
            // (e.g., based on card position in deck)
            const cardIndex = Array.from(img.parentElement.parentElement.children).indexOf(img.parentElement);
            if (cardIndex < 10) { // First 10 cards
                priority += 20;
            }
            
            return priority;
        }
        
        function isInViewport(element) {
            const rect = element.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }
        
        function isNearViewport(element, threshold = 200) {
            const rect = element.getBoundingClientRect();
            return (
                rect.top >= -threshold &&
                rect.left >= -threshold &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) + threshold &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth) + threshold
            );
        }
        
        function preloadImage(img, originalSrc) {
            if (img.dataset.loadedResolution) {
                return; // Already loaded
            }
            
            // Start with standard resolution
            const regularProxy = `/api/proxy-image?url=${encodeURIComponent(originalSrc)}`;
            
            const preloadImg = new Image();
            preloadImg.onload = function() {
                img.src = regularProxy;
                img.dataset.loadedResolution = 'standard';
                
                
                // After a delay, try to upgrade to high-resolution
                setTimeout(() => {
                    const highResSrc = originalSrc.replace('/cards/', '/high_res_cards/');
                    const highResProxy = `/api/proxy-image?url=${encodeURIComponent(highResSrc)}`;
                    
                    const highResImg = new Image();
                    highResImg.onload = function() {
                        img.src = highResProxy;
                        img.dataset.loadedResolution = 'high';
                    };
                    highResImg.onerror = function() {
                    };
                    highResImg.src = highResProxy;
                }, 2000); // 2 second delay before trying high-res
            };
            preloadImg.onerror = function() {
            };
            preloadImg.src = regularProxy;
        }
        
        // Intersection Observer for dynamic preloading
        function setupIntersectionObserver() {
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const originalSrc = img.getAttribute('data-original-src');
                            
                            if (originalSrc && !img.dataset.loadedResolution) {
                                preloadImage(img, originalSrc);
                            }
                            
                            // Stop observing once loaded
                            observer.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '50px' // Start loading 50px before entering viewport
                });
                
                // Observe all card images
                document.querySelectorAll('.card-image').forEach(img => {
                    observer.observe(img);
                });
            }
        }
        
        // Load energy icon through proxy
        function loadEnergyIcon(icon, originalSrc) {
            return new Promise((resolve) => {
                const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(originalSrc)}`;
                icon.src = proxyUrl;
                resolve();
            });
        }
        

        // Register Service Worker for persistent image caching
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/static/js/image-cache-sw.js')
                    .then(registration => {
                        console.log('Image cache service worker registered:', registration);
                        
                        // Listen for service worker updates
                        registration.addEventListener('updatefound', () => {
                            console.log('Service worker update found');
                        });
                    })
                    .catch(error => {
                        console.error('Service worker registration failed:', error);
                    });
            }
        }
        
        // Get cache statistics from service worker
        function getServiceWorkerCacheStats() {
            return new Promise((resolve, reject) => {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    const messageChannel = new MessageChannel();
                    messageChannel.port1.onmessage = (event) => {
                        resolve(event.data);
                    };
                    
                    navigator.serviceWorker.controller.postMessage(
                        { type: 'CACHE_STATS' },
                        [messageChannel.port2]
                    );
                } else {
                    reject(new Error('Service worker not available'));
                }
            });
        }
        
        // Clear service worker cache
        function clearServiceWorkerCache() {
            return new Promise((resolve, reject) => {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    const messageChannel = new MessageChannel();
                    messageChannel.port1.onmessage = (event) => {
                        resolve(event.data);
                    };
                    
                    navigator.serviceWorker.controller.postMessage(
                        { type: 'CLEAR_CACHE' },
                        [messageChannel.port2]
                    );
                } else {
                    reject(new Error('Service worker not available'));
                }
            });
        }
        
        // Initialize default state
        document.addEventListener('DOMContentLoaded', function() {
            
            // Register service worker for persistent caching
            registerServiceWorker();
            
            // Initialize UI immediately
            initializeUI();
            
            // Wait for dom-to-image to be fully loaded
            setTimeout(function() {
                
                try {
                    // Start with automatic layout detection (Auto mode)
                    window.userLayoutPreference = 'auto'; // Start in auto mode
                    toggleLayout('auto'); // This will trigger checkAndApplyAutoLayout
                    
                    // Detect parent window's theme preference
                    let parentTheme = 'dark'; // Default to dark
                    try {
                        // Check if we can access parent window's theme
                        if (window.opener && window.opener.document) {
                            const parentHtmlElement = window.opener.document.documentElement;
                            const parentThemeAttr = parentHtmlElement.getAttribute('data-theme');
                            
                            if (parentThemeAttr === 'dark' || parentThemeAttr === null) {
                                parentTheme = 'dark';
                            } else {
                                parentTheme = 'light';
                            }
                        } else {
                            // Fallback: check localStorage
                            const savedTheme = localStorage.getItem('theme');
                            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                            
                            
                            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                                parentTheme = 'dark';
                            } else if (savedTheme === 'light') {
                                parentTheme = 'light';
                            }
                        }
                    } catch (e) {
                        console.log('Could not detect parent theme, using default dark theme');
                    }
                    
                    toggleTheme(parentTheme);
                    
                    // Quality and format are now selected in the download modal
                    window.selectedQuality = 'high'; // Default fallback
                    window.selectedExportFormat = '5x4'; // Default fallback
                    
                    // Start loading immediately since we're using placeholders
                    loadAllImagesWithProxy();
                    
                    // Setup intelligent preloading after initial load
                    setTimeout(() => {
                        setupIntersectionObserver();
                        implementIntelligentPreloading();
                    }, 3000); // Start preloading after 3 seconds
                    
                    // Ensure proper layout after initialization
                    if (window.userLayoutPreference === 'auto') {
                        checkAndApplyAutoLayout();
                    } else if (window.userLayoutPreference === '5x4') {
                        applyDynamicSizing5x4();
                    }
                    
                } catch (error) {
                    console.error('Error during initialization:', error);
                    // Reset UI on initialization error
                    resetUI();
                }
            }, 100);
        });
        
        // Debounce function to prevent rapid-fire events
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Flag to prevent concurrent sizing operations
        let isResizing = false;
        
        // Cache for dynamic sizing calculations
        let sizingCache = {
            layout2x10: { containerWidth: 0, bestCardWidth: 0, bestGap: 0 },
            layout5x4: { containerWidth: 0, bestCardWidth: 0, bestGap: 0 }
        };
        
        // Handle window resize with debouncing to prevent flashing
        const handleResize = debounce(function() {
            if (isResizing) return;
            isResizing = true;
            
            // Use requestAnimationFrame for smoother updates
            requestAnimationFrame(() => {
                // Only auto-adjust if in auto mode
                if (window.userLayoutPreference === 'auto') {
                    checkAndApplyAutoLayout();
                } else if (window.userLayoutPreference === '2x10') {
                    // Re-apply dynamic sizing for 2x10 layout
                    applyDynamicSizing2x10();
                } else if (window.userLayoutPreference === '5x4') {
                    // Re-apply dynamic sizing for 5x4 layout
                    applyDynamicSizing5x4();
                }
                // Forced layouts maintain their settings regardless of container size
                // The cards grid will scroll horizontally if needed
                
                isResizing = false;
            });
        }, 150);
        
        window.addEventListener('resize', handleResize);
    </script>
</body>
</html>