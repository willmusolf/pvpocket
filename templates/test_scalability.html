<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalability Test Dashboard - PvPocket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .metric-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-bad { color: #dc3545; }
        .log-entry {
            padding: 5px 10px;
            margin: 2px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .log-success { background-color: #d4edda; }
        .log-warning { background-color: #fff3cd; }
        .log-error { background-color: #f8d7da; }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üöÄ Scalability Test Dashboard</span>
            <span class="navbar-text" id="test-status">
                <span class="spinner-border spinner-border-sm" role="status"></span>
                Initializing...
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- System Status -->
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card">
                    <h6>Cache Status</h6>
                    <div class="metric-value" id="cache-status">-</div>
                    <small class="text-muted">In-Memory</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <h6>Response Time</h6>
                    <div class="metric-value" id="response-time">-</div>
                    <small class="text-muted">Average (ms)</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <h6>Cache Hit Rate</h6>
                    <div class="metric-value" id="cache-hit-rate">-</div>
                    <small class="text-muted">Last 100 requests</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <h6>Active Systems</h6>
                    <div class="metric-value" id="active-systems">0/4</div>
                    <small class="text-muted">Monitoring Status</small>
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">üß™ Performance Tests</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-primary w-100 mb-2" onclick="runCacheTest()">
                            Test Cache Performance
                        </button>
                        <button class="btn btn-success w-100 mb-2" onclick="runLoadTest()">
                            Run Load Test (10 users)
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-info w-100 mb-2" onclick="checkSystems()">
                            Check All Systems
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="clearLogs()">
                            Clear Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Logs -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">üìä Live Test Results</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="log-container"></div>
            </div>
        </div>

        <!-- Detailed Metrics -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">üìà Detailed Metrics</h5>
            </div>
            <div class="card-body">
                <pre id="metrics-display" class="bg-light p-3">Click "Check All Systems" to load metrics...</pre>
            </div>
        </div>
    </div>

    <script>
        let testResults = {
            cacheHits: 0,
            cacheMisses: 0,
            responseTimes: [],
            errors: 0
        };

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Keep only last 50 logs
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function updateStatus(message, isLoading = false) {
            const statusEl = document.getElementById('test-status');
            statusEl.innerHTML = isLoading 
                ? `<span class="spinner-border spinner-border-sm" role="status"></span> ${message}`
                : message;
        }

        async function checkSystems() {
            updateStatus('Checking systems...', true);
            addLog('Starting system check...', 'info');
            
            try {
                // Check scalability endpoint
                const response = await fetch('/test-scalability');
                const data = await response.json();
                
                document.getElementById('cache-status').textContent = 
                    data.cache_status?.includes('‚úÖ') ? '‚úÖ Active' : '‚ùå Inactive';
                
                let activeSystems = 0;
                if (data.cache_status?.includes('‚úÖ')) activeSystems++;
                if (data.db_status?.includes('‚úÖ')) activeSystems++;
                if (data.card_service_status?.includes('‚úÖ')) activeSystems++;
                
                document.getElementById('active-systems').textContent = `${activeSystems}/3`;
                
                addLog(`Cache: ${data.cache_status}`, data.cache_status?.includes('‚úÖ') ? 'success' : 'error');
                addLog(`Database: ${data.db_status}`, data.db_status?.includes('‚úÖ') ? 'success' : 'error');
                addLog(`Cards loaded: ${data.total_cards}`, 'success');
                
                // Check monitoring
                try {
                    const metricsResponse = await fetch('/internal/metrics');
                    const metrics = await metricsResponse.json();
                    document.getElementById('metrics-display').textContent = 
                        JSON.stringify(metrics, null, 2);
                    addLog('Monitoring system active', 'success');
                    activeSystems++;
                    document.getElementById('active-systems').textContent = `${activeSystems}/4`;
                } catch (e) {
                    addLog('Monitoring system not accessible', 'warning');
                }
                
                updateStatus('‚úÖ Systems checked');
            } catch (error) {
                addLog(`System check failed: ${error.message}`, 'error');
                updateStatus('‚ùå Check failed');
            }
        }

        async function runCacheTest() {
            updateStatus('Running cache test...', true);
            addLog('Starting cache performance test...', 'info');
            
            const endpoints = ['/', '/test-scalability'];
            
            for (const endpoint of endpoints) {
                // First request (cache miss)
                const start1 = performance.now();
                await fetch(endpoint);
                const time1 = performance.now() - start1;
                
                // Second request (cache hit)
                const start2 = performance.now();
                await fetch(endpoint);
                const time2 = performance.now() - start2;
                
                const improvement = ((time1 - time2) / time1 * 100).toFixed(1);
                const isCacheHit = time2 < time1 * 0.7;
                
                if (isCacheHit) {
                    testResults.cacheHits++;
                    addLog(`${endpoint}: Cache HIT! ${improvement}% faster (${time1.toFixed(0)}ms ‚Üí ${time2.toFixed(0)}ms)`, 'success');
                } else {
                    testResults.cacheMisses++;
                    addLog(`${endpoint}: Cache MISS or minimal improvement`, 'warning');
                }
                
                testResults.responseTimes.push(time2);
            }
            
            updateCacheHitRate();
            updateStatus('‚úÖ Cache test complete');
        }

        async function runLoadTest() {
            updateStatus('Running load test...', true);
            addLog('Starting load test with 10 concurrent users...', 'info');
            
            const numUsers = 10;
            const requestsPerUser = 5;
            const startTime = performance.now();
            
            const userPromises = [];
            
            for (let user = 0; user < numUsers; user++) {
                const userRequests = async () => {
                    const userTimes = [];
                    for (let req = 0; req < requestsPerUser; req++) {
                        const reqStart = performance.now();
                        try {
                            await fetch('/');
                            const reqTime = performance.now() - reqStart;
                            userTimes.push(reqTime);
                            testResults.responseTimes.push(reqTime);
                        } catch (error) {
                            testResults.errors++;
                        }
                        // Simulate think time
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return userTimes;
                };
                userPromises.push(userRequests());
            }
            
            const results = await Promise.all(userPromises);
            const totalTime = performance.now() - startTime;
            
            const allTimes = results.flat();
            const avgTime = allTimes.reduce((a, b) => a + b, 0) / allTimes.length;
            const maxTime = Math.max(...allTimes);
            const minTime = Math.min(...allTimes);
            
            addLog(`Load test complete in ${(totalTime/1000).toFixed(2)}s`, 'success');
            addLog(`Average response: ${avgTime.toFixed(0)}ms`, avgTime < 1000 ? 'success' : 'warning');
            addLog(`Min/Max response: ${minTime.toFixed(0)}ms / ${maxTime.toFixed(0)}ms`, 'info');
            addLog(`Requests per second: ${(numUsers * requestsPerUser / (totalTime/1000)).toFixed(1)}`, 'info');
            
            updateResponseTime();
            updateStatus('‚úÖ Load test complete');
        }

        function updateCacheHitRate() {
            const total = testResults.cacheHits + testResults.cacheMisses;
            if (total > 0) {
                const rate = (testResults.cacheHits / total * 100).toFixed(1);
                const el = document.getElementById('cache-hit-rate');
                el.textContent = `${rate}%`;
                el.className = 'metric-value ' + 
                    (rate > 70 ? 'status-good' : rate > 40 ? 'status-warning' : 'status-bad');
            }
        }

        function updateResponseTime() {
            if (testResults.responseTimes.length > 0) {
                const avg = testResults.responseTimes.reduce((a, b) => a + b, 0) / 
                           testResults.responseTimes.length;
                const el = document.getElementById('response-time');
                el.textContent = avg.toFixed(0);
                el.className = 'metric-value ' + 
                    (avg < 500 ? 'status-good' : avg < 2000 ? 'status-warning' : 'status-bad');
            }
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            addLog('Logs cleared', 'info');
        }

        // Initialize on load
        window.onload = () => {
            addLog('Dashboard loaded - click "Check All Systems" to start', 'info');
            updateStatus('Ready');
        };
    </script>
</body>
</html>